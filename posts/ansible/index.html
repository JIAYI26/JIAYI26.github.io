<!doctype html><html lang=en dir=auto><head><meta name="referrer" content="no-referrer"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible | JIAYI's Blog</title><meta name=keywords content="Ansible"><meta name=description content="Ansible的概述 Ansible 是基于 Python 开发，集合了众多运维工具（puppet、cfengine、chef、func、 fabric）的优点实现了批量系统配置、批量程序部署、批量运行命令等功能的自动化运维工具。
它基于模块工作，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块。基于ssh协议来实现远程管理，不需要在被执行主机上安装代理。
Ansible的核心组件  Ansible：核心组件 Modules：包括Ansible自带的核心模块及自定义模块 Plugins：完成模块功能的补充，包括连接插件、邮箱插件 Playbook：剧本；定义Ansible多任务配置文件，完成对主机批量部署操作 Inventory：定义Ansible管理主机的清单 /etc/ansibe/hosts Connection Plugins：负责和被监控端实现通信  Ansible的安装和使用 安装 [root@manager01 ~]# yum install -y ansible 执行模式  ad-hoc模式（点对点模式）：使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。 playbook模式（剧本模式）：是Ansible主要管理方式，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。  Ansible的配置文件 [root@manager01 ansible]# pwd /etc/ansible [root@manager01 ansible]# vim ansible.cfg inventory = /etc/ansible/hosts	#存放主机清单的文件 forks =5	#并发数，默认5 sudo_user = root	#的执行用户 remote_port = 22	#远程连接端口 host_key_checking = False	#关闭之后第一次连接的远程主机不用输入yes log_path = /var/log/ansible.log	#存放日志的文件 Inventory #/etc/ansible/hosts [root@manager01 ansible]# vim hosts # Ex 1: Ungrouped hosts, specify before any group headers."><meta name=author content="Me"><link rel=canonical href=https://jiayi26.github.io/posts/ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=icon type=image/png sizes=16x16 href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=icon type=image/png sizes=32x32 href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=apple-touch-icon href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=mask-icon href=https://jiayi26.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Ansible"><meta property="og:description" content="Ansible的概述 Ansible 是基于 Python 开发，集合了众多运维工具（puppet、cfengine、chef、func、 fabric）的优点实现了批量系统配置、批量程序部署、批量运行命令等功能的自动化运维工具。
它基于模块工作，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块。基于ssh协议来实现远程管理，不需要在被执行主机上安装代理。
Ansible的核心组件  Ansible：核心组件 Modules：包括Ansible自带的核心模块及自定义模块 Plugins：完成模块功能的补充，包括连接插件、邮箱插件 Playbook：剧本；定义Ansible多任务配置文件，完成对主机批量部署操作 Inventory：定义Ansible管理主机的清单 /etc/ansibe/hosts Connection Plugins：负责和被监控端实现通信  Ansible的安装和使用 安装 [root@manager01 ~]# yum install -y ansible 执行模式  ad-hoc模式（点对点模式）：使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。 playbook模式（剧本模式）：是Ansible主要管理方式，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。  Ansible的配置文件 [root@manager01 ansible]# pwd /etc/ansible [root@manager01 ansible]# vim ansible.cfg inventory = /etc/ansible/hosts	#存放主机清单的文件 forks =5	#并发数，默认5 sudo_user = root	#的执行用户 remote_port = 22	#远程连接端口 host_key_checking = False	#关闭之后第一次连接的远程主机不用输入yes log_path = /var/log/ansible.log	#存放日志的文件 Inventory #/etc/ansible/hosts [root@manager01 ansible]# vim hosts # Ex 1: Ungrouped hosts, specify before any group headers."><meta property="og:type" content="article"><meta property="og:url" content="https://jiayi26.github.io/posts/ansible/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-16T22:21:29+08:00"><meta property="article:modified_time" content="2021-09-16T22:21:29+08:00"><meta property="og:site_name" content="JIAYI's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ansible"><meta name=twitter:description content="Ansible的概述 Ansible 是基于 Python 开发，集合了众多运维工具（puppet、cfengine、chef、func、 fabric）的优点实现了批量系统配置、批量程序部署、批量运行命令等功能的自动化运维工具。
它基于模块工作，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块。基于ssh协议来实现远程管理，不需要在被执行主机上安装代理。
Ansible的核心组件  Ansible：核心组件 Modules：包括Ansible自带的核心模块及自定义模块 Plugins：完成模块功能的补充，包括连接插件、邮箱插件 Playbook：剧本；定义Ansible多任务配置文件，完成对主机批量部署操作 Inventory：定义Ansible管理主机的清单 /etc/ansibe/hosts Connection Plugins：负责和被监控端实现通信  Ansible的安装和使用 安装 [root@manager01 ~]# yum install -y ansible 执行模式  ad-hoc模式（点对点模式）：使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。 playbook模式（剧本模式）：是Ansible主要管理方式，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。  Ansible的配置文件 [root@manager01 ansible]# pwd /etc/ansible [root@manager01 ansible]# vim ansible.cfg inventory = /etc/ansible/hosts	#存放主机清单的文件 forks =5	#并发数，默认5 sudo_user = root	#的执行用户 remote_port = 22	#远程连接端口 host_key_checking = False	#关闭之后第一次连接的远程主机不用输入yes log_path = /var/log/ansible.log	#存放日志的文件 Inventory #/etc/ansible/hosts [root@manager01 ansible]# vim hosts # Ex 1: Ungrouped hosts, specify before any group headers."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jiayi26.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Ansible","item":"https://jiayi26.github.io/posts/ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible","name":"Ansible","description":"Ansible的概述 Ansible 是基于 Python 开发，集合了众多运维工具（puppet、cfengine、chef、func、 fabric）的优点实现了批量系统配置、批量程序部署、批量运行命令等功能的自动化运维工具。\n它基于模块工作，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块。基于ssh协议来实现远程管理，不需要在被执行主机上安装代理。\nAnsible的核心组件  Ansible：核心组件 Modules：包括Ansible自带的核心模块及自定义模块 Plugins：完成模块功能的补充，包括连接插件、邮箱插件 Playbook：剧本；定义Ansible多任务配置文件，完成对主机批量部署操作 Inventory：定义Ansible管理主机的清单 /etc/ansibe/hosts Connection Plugins：负责和被监控端实现通信  Ansible的安装和使用 安装 [root@manager01 ~]# yum install -y ansible 执行模式  ad-hoc模式（点对点模式）：使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。 playbook模式（剧本模式）：是Ansible主要管理方式，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。  Ansible的配置文件 [root@manager01 ansible]# pwd /etc/ansible [root@manager01 ansible]# vim ansible.cfg inventory = /etc/ansible/hosts\t#存放主机清单的文件 forks =5\t#并发数，默认5 sudo_user = root\t#的执行用户 remote_port = 22\t#远程连接端口 host_key_checking = False\t#关闭之后第一次连接的远程主机不用输入yes log_path = /var/log/ansible.log\t#存放日志的文件 Inventory #/etc/ansible/hosts [root@manager01 ansible]# vim hosts # Ex 1: Ungrouped hosts, specify before any group headers.","keywords":["Ansible"],"articleBody":"Ansible的概述 Ansible 是基于 Python 开发，集合了众多运维工具（puppet、cfengine、chef、func、 fabric）的优点实现了批量系统配置、批量程序部署、批量运行命令等功能的自动化运维工具。\n它基于模块工作，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块。基于ssh协议来实现远程管理，不需要在被执行主机上安装代理。\nAnsible的核心组件  Ansible：核心组件 Modules：包括Ansible自带的核心模块及自定义模块 Plugins：完成模块功能的补充，包括连接插件、邮箱插件 Playbook：剧本；定义Ansible多任务配置文件，完成对主机批量部署操作 Inventory：定义Ansible管理主机的清单 /etc/ansibe/hosts Connection Plugins：负责和被监控端实现通信  Ansible的安装和使用 安装 [root@manager01 ~]# yum install -y ansible 执行模式  ad-hoc模式（点对点模式）：使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。 playbook模式（剧本模式）：是Ansible主要管理方式，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。  Ansible的配置文件 [root@manager01 ansible]# pwd /etc/ansible [root@manager01 ansible]# vim ansible.cfg inventory = /etc/ansible/hosts\t#存放主机清单的文件 forks =5\t#并发数，默认5 sudo_user = root\t#的执行用户 remote_port = 22\t#远程连接端口 host_key_checking = False\t#关闭之后第一次连接的远程主机不用输入yes log_path = /var/log/ansible.log\t#存放日志的文件 Inventory #/etc/ansible/hosts [root@manager01 ansible]# vim hosts # Ex 1: Ungrouped hosts, specify before any group headers.  ## green.example.com ## blue.example.com ## 192.168.100.1 ## 192.168.100.10  # Ex 2: A collection of hosts belonging to the 'webservers' group  ## [webservers] ## alpha.example.org ## beta.example.org ## 192.168.1.100 ## 192.168.1.110  # If you have multiple hosts following a pattern you can specify # them like this:  ## www[001:006].example.com  # Ex 3: A collection of database servers in the 'dbservers' group  ## [dbservers] ##  ## db01.intranet.mydomain.net ## db02.intranet.mydomain.net ## 10.25.1.56 ## 10.25.1.57  # Here's another example of host ranges, this time there are no # leading 0s:  ## db-[99:101]-node.example.com 方括号[]中是组名，用于对系统进行分类，便于对不同系统进行个别的管理。\n一个系统可以属于不同的组，比如一台服务器可以同时属于 webserver组 和 dbserver组.这时属于两个组的变量都可以为这台主机所用\n#如果有主机的SSH端口不是标准的22端口，可在主机名之后加上端口号，用冒号分隔，如： 192.168.1.100:6666  #一组相似的 hostname , 可简写成如下： www[001:006].example.com  #定义字母范围的简写模式 db-[99:101]-node.example.com 主机变量\n[webservers] 192.168.1.100 http_port=80 192.168.1.110 http_port=8080 组的变量\n#定义整个组的变量 [webservers] 192.168.1.100 192.168.1.110  [webservers:vars] http_port=80 把一个组作为另一个组的子成员\n[webservers] 192.168.1.100 192.168.1.110  [dbservers] 192.168.1.180 192.168.1.190  [general:children] webservers dbservers  [general:vars] gather_timeout=10 connect_timeout=30 分文件定义 Host 和 Group 变量\n在 inventory 主文件中保存所有的变量并不是最佳的方式。还可以保存在独立的文件中，这些独立文件与 inventory 文件保持关联。不同于 inventory 文件(INI 格式)，这些独立文件的格式为 YAML。\n假设有一个主机名为 foosball，主机同时属于两个组,一个是 raleigh， 另一个是 webservers。那么以下配置文件(YAML 格式)中的变量可以为 foosball主机所用。\n/etc/ansible/group_vars/dbservers /etc/ansible/group_vars/webservers /etc/ansible/host_vars/foosball 还可以为一个主机,或一个组，创建一个目录，目录名就是主机名或组名。目录中的可以创建多个文件，文件中的变量都会被读取为主机或组的变量。\n/etc/ansible/group_vars/dbservers/db_settings\r/etc/ansible/group_vars/dbservers/cluster_settings  Ansible 1.2 及以上的版本中，group_vars/ 和 host_vars/ 目录可放在 inventory 目录下，或是 playbook 目录下。如果两个目录下都存在，那么 playbook 目录下的配置会覆盖 inventory 目录的配置。\n Ad-Hoc 命令的介绍 ssh免密登录 #生成密钥，过程直接输入回车即可 [root@manager01 ~]# ssh-keygen -t rsa Generating public/private rsa key pair. Enter file in which to save the key (/root/.ssh/id_rsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_rsa. Your public key has been saved in /root/.ssh/id_rsa.pub. The key fingerprint is: SHA256:kx03zvb/XtCE94TMRlL4rRRdC+/PGetBuhZwFW1zpjE root@manager01 The key's randomart image is: +---[RSA 2048]----+ | .+oo=| | .=E=B| | . o.B@*| | o * +==o| | S . *..=o| | . . o+o=| | .o++| | .o.o| | .. o=| +----[SHA256]-----+  #把公钥分发到其他主机 [root@manager01 ~]# ssh-copy-id 192.168.31.23 [root@manager01 ~]# ssh-copy-id 192.168.31.33  #先配置好hosts [root@manager01 ~]# vim /etc/ansible/hosts 192.168.31.23  [web] 192.168.31.48 192.168.31.23  [db] 192.168.31.23 192.168.31.33  [storage] 192.168.31.33 192.168.31.48  [root@manager01 ~]# ansible all -m ping 192.168.31.33 | SUCCESS = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false,  \"ping\": \"pong\" } 192.168.31.23 | SUCCESS = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false,  \"ping\": \"pong\" } 192.168.31.48 | SUCCESS = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false,  \"ping\": \"pong\" } 常用模块介绍 command：ansible默认模块，用于执行Linux基础命令\n[root@manager01 ~]# ansible-doc command -s - name: Execute commands on targets  command:  argv: # Passes the command as a list rather than a string. Use `argv' to avoid quoting values that would otherwise be  interpreted incorrectly (for example \"user name\"). Only the string or the list form can  be provided, not both. One or the other must be provided.  chdir: # Change into this directory before running the command.  cmd: # The command to run.  creates: # A filename or (since 2.0) glob pattern. If it already exists, this step *won't* be run.  free_form: # The command module takes a free form command to run. There is no actual parameter named 'free form'.  removes: # A filename or (since 2.0) glob pattern. If it already exists, this step *will* be run.  stdin: # Set the stdin of the command directly to the specified value.  stdin_add_newline: # If set to `yes', append a newline to stdin data.  strip_empty_ends: # Strip empty lines from the end of stdout/stderr in result.  warn: # Enable or disable task warnings.  #-m不写默认就是用command模块 [root@manager01 ~]# ansible 192.168.31.23 -m command -a \"ls\" 192.168.31.23 | CHANGED | rc=0  anaconda-ks.cfg  [root@manager01 ~]# ansible 192.168.31.23 -a \"chdir=/tmp pwd\" 192.168.31.23 | CHANGED | rc=0  /tmp shell：和command相似，shell支持特殊字符\n[root@manager01 ~]# ansible 192.168.31.23 -m shell -a 'env |grep SHELL'  192.168.31.23 | CHANGED | rc=0  SHELL=/bin/bash  [root@node01 tmp]# vi test.sh #!/bin/bash echo \"hello ansible\"  [root@manager01 ~]# ansible 192.168.31.23 -m shell -a \"/bin/bash /tmp/test.sh\" 192.168.31.23 | CHANGED | rc=0  hello ansible script：在远程主机上运行ansible服务器上的脚本\n[root@manager01 tmp]# cat scripts.sh  #!/bin/bash echo \"hello ansible\"  [root@manager01 ~]# ansible 192.168.31.23 -m script -a \"/tmp/scripts.sh\" 192.168.31.23 | CHANGED = {  \"changed\": true,  \"rc\": 0,  \"stderr\": \"Shared connection to 192.168.31.23 closed.\\r\\n\",  \"stderr_lines\": [  \"Shared connection to 192.168.31.23 closed.\"  ],  \"stdout\": \"hello ansible\\r\\n\",  \"stdout_lines\": [  \"hello ansible\"  ] } user：管理用户\n#创建一个系统用户web，属组是root，uid=10086，禁止登录 [root@manager01 ~]# ansible 192.168.31.23 -m user -a \"name=web system=yes groups=root uid=10086 shell=/sbin/nologin state=present\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"comment\": \"\",  \"create_home\": true,  \"group\": 993,  \"groups\": \"root\",  \"home\": \"/home/web\",  \"name\": \"web\",  \"shell\": \"/sbin/nologin\",  \"state\": \"present\",  \"system\": true,  \"uid\": 10086 }  [root@manager01 ~]# ansible 192.168.31.23 -a \"id web\" 192.168.31.23 | CHANGED | rc=0  uid=10086(web) gid=993(web) 组=993(web),0(root)  #删除用户 [root@manager01 ~]# ansible 192.168.31.23 -m user -a \"name=web state=absent remove=yes\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"force\": false,  \"name\": \"web\",  \"remove\": true,  \"state\": \"absent\",  \"stderr\": \"userdel: web 邮件池 (/var/spool/mail/web) 未找到\\n\",  \"stderr_lines\": [  \"userdel: web 邮件池 (/var/spool/mail/web) 未找到\"  ] } [root@manager01 ~]# ansible 192.168.31.23 -a \"id web\" 192.168.31.23 | FAILED | rc=1  id: web: no such usernon-zero return code group：管理组\n#创建组web，gid=10086 [root@manager01 ~]# ansible 192.168.31.23 -m group -a \"name=web system=yes gid=10086 state=present\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"gid\": 10086,  \"name\": \"web\",  \"state\": \"present\",  \"system\": true }  [root@manager01 ~]# ansible 192.168.31.23 -a \"getent group web\" 192.168.31.23 | CHANGED | rc=0  web:x:10086:  #删除组 [root@manager01 ~]# ansible 192.168.31.23 -m group -a \"name=web state=absent\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"name\": \"web\",  \"state\": \"absent\" } [root@manager01 ~]# ansible 192.168.31.23 -a \"getent group web\" 192.168.31.23 | FAILED | rc=2  non-zero return code setup：收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度。\n[root@manager01 ~]# ansible 192.168.31.23 -m setup  #筛选需要的信息 [root@manager01 ~]# ansible 192.168.31.23 -m setup -a \"filter=ansible_hostname\" 192.168.31.23 | SUCCESS = {  \"ansible_facts\": {  \"ansible_hostname\": \"node01\",  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false }  [root@manager01 ~]# ansible 192.168.31.23 -m setup -a \"filter=ansible_default_ipv4\" 192.168.31.23 | SUCCESS = {  \"ansible_facts\": {  \"ansible_default_ipv4\": {  \"address\": \"192.168.31.23\",  \"alias\": \"ens33\",  \"broadcast\": \"192.168.31.255\",  \"gateway\": \"192.168.31.1\",  \"interface\": \"ens33\",  \"macaddress\": \"00:0c:29:1b:07:16\",  \"mtu\": 1500,  \"netmask\": \"255.255.255.0\",  \"network\": \"192.168.31.0\",  \"type\": \"ether\"  },  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false } copy：复制文件到远程主机\n[root@manager01 tmp]# ansible 192.168.31.23 -m copy -a \"src=/tmp/scripts.sh dest=/tmp/scripts.sh backup=yes\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"checksum\": \"6e979f8744e8e0b07fa3db3a0d41081241ef3feb\",  \"dest\": \"/tmp/scripts.sh\",  \"gid\": 0,  \"group\": \"root\",  \"md5sum\": \"ed1cd6048daee9ff5a8e031a09adb182\",  \"mode\": \"0644\",  \"owner\": \"root\",  \"secontext\": \"unconfined_u:object_r:admin_home_t:s0\",  \"size\": 33,  \"src\": \"/root/.ansible/tmp/ansible-tmp-1679005928.95-69209-264876077265452/source\",  \"state\": \"file\",  \"uid\": 0 } fetch：从远程主机提取文件至ansible服务器\n[root@manager01 tmp]# ansible 192.168.31.23 -m fetch -a \"src=/tmp/test.sh dest=/tmp\" 192.168.31.23 | CHANGED = {  \"changed\": true,  \"checksum\": \"6e979f8744e8e0b07fa3db3a0d41081241ef3feb\",  \"dest\": \"/tmp/192.168.31.23/tmp/test.sh\",  \"md5sum\": \"ed1cd6048daee9ff5a8e031a09adb182\",  \"remote_checksum\": \"6e979f8744e8e0b07fa3db3a0d41081241ef3feb\",  \"remote_md5sum\": null }  #会看到一个一ip命名的文件夹 [root@manager01 tmp]# ls 192.168.31.23 scripts.sh file：设置文件属性，创建目录、文件\n#创建目录 [root@manager01 ~]# ansible 192.168.31.23 -m file -a \"path=/file state=directory\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"gid\": 0,  \"group\": \"root\",  \"mode\": \"0755\",  \"owner\": \"root\",  \"path\": \"/file\",  \"secontext\": \"unconfined_u:object_r:default_t:s0\",  \"size\": 6,  \"state\": \"directory\",  \"uid\": 0 }  #创建文件 [root@manager01 ~]# ansible 192.168.31.23 -m file -a \"path=/file/file.txt state=touch\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"dest\": \"/file/file.txt\",  \"gid\": 0,  \"group\": \"root\",  \"mode\": \"0644\",  \"owner\": \"root\",  \"secontext\": \"unconfined_u:object_r:default_t:s0\",  \"size\": 0,  \"state\": \"file\",  \"uid\": 0 } stat：查看文件的属性状态\n[root@manager01 ~]# ansible 192.168.31.23 -m stat -a \"path=/file/file.txt\" 192.168.31.23 | SUCCESS = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false,  \"stat\": {  \"atime\": 1678991161.9935107,  \"attr_flags\": \"\",  \"attributes\": [],  \"block_size\": 4096,  \"blocks\": 0,  \"charset\": \"binary\",  \"checksum\": \"da39a3ee5e6b4b0d3255bfef95601890afd80709\",  \"ctime\": 1678991161.9935107,  \"dev\": 64768,  \"device_type\": 0,  \"executable\": false,  \"exists\": true,  \"gid\": 0,  \"gr_name\": \"root\",  \"inode\": 1787370,  \"isblk\": false,  \"ischr\": false,  \"isdir\": false,  \"isfifo\": false,  \"isgid\": false,  \"islnk\": false,  \"isreg\": true,  \"issock\": false,  \"isuid\": false,  \"mimetype\": \"inode/x-empty\",  \"mode\": \"0644\",  \"mtime\": 1678991161.9935107,  \"nlink\": 1,  \"path\": \"/file/file.txt\",  \"pw_name\": \"root\",  \"readable\": true,  \"rgrp\": true,  \"roth\": true,  \"rusr\": true,  \"size\": 0,  \"uid\": 0,  \"version\": \"18446744073193559713\",  \"wgrp\": false,  \"woth\": false,  \"writeable\": true,  \"wusr\": true,  \"xgrp\": false,  \"xoth\": false,  \"xusr\": false  } } yum：管理软件包\n#查看软件包 [root@manager01 ~]# ansible 192.168.31.23 -m yum -a \"list=nginx\" 192.168.31.23 | SUCCESS = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false,  \"results\": [  {  \"arch\": \"x86_64\",  \"envra\": \"1:nginx-1.20.1-10.el7.x86_64\",  \"epoch\": \"1\",  \"name\": \"nginx\",  \"release\": \"10.el7\",  \"repo\": \"epel\",  \"version\": \"1.20.1\",  \"yumstate\": \"available\"  }  ] }  #安装软件 [root@manager01 ~]# ansible 192.168.31.23 -m yum -a \"name=nginx state=present\"  #卸载软件 [root@manager01 ~]# ansible 192.168.31.23 -m yum -a \"name=nginx state=absent\" service：管理服务\n#启动nginx，设置开启自启，state=restarted重启服务，state=stopped停止服务，state=reloded，重新加载 [root@manager01 ~]# ansible 192.168.31.23 -m service -a \"name=nginx state=started enabled=yes\" 192.168.31.23 | CHANGED = {  \"ansible_facts\": {  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": true,  \"enabled\": true,  \"name\": \"nginx\",  \"state\": \"started\",  \"status\": { playbook 剧本 playbook的核心元素  Hosts 执行的远程主机列表 Tasks 任务集 Varniables 内置变量或自定义变量在playbook中调用 Templates 模板，即使用模板语法的文件，比如配置文件等 Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行 Tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码  [root@manager01 ~]# ansible 192.168.31.23 -m yum -a \"name=nginx state=present\" [root@manager01 ~]# ansible 192.168.31.23 -m service -a \"name=nginx state=started enabled=yes\"  #现在把以上两条命令写成playbook - hosts: 192.168.31.23  remote_user: root  tasks:  - name: install nginx  yum: name=nginx state=present  - name: start nginx  service: name=nginx state=started enabled=yes  #综合以上创建一个playbook [root@manager01 playbook]# cat nginx.yml - hosts: db  remote_user: root  tasks:  - name: create www user  user: name=www system=yes uid=82 shell=/sbin/nologin  - name: create web root  file: name=/data/playbook/html state=directory  - name: create web index  shell: echo 'hello ansible' /data/playbook/html/index.html  - name: install nginx  yum: name=nginx state=present  - name: copy config  copy: src=/data/playbook/nginx.conf dest=/etc/nginx/nginx.conf  - name: start nginx  service: name=nginx state=started enabled=yes  #检查语法 --syntax-check [root@manager01 playbook]# ansible-playbook nginx.yml --syntax-check  playbook: nginx.yml  #模拟执行playbook -C [root@manager01 playbook]# ansible-playbook nginx.yml -C  #执行playbook [root@manager01 playbook]# ansible-playbook nginx.yml  PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [create www user] ********************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33]  TASK [create web root] ********************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33]  TASK [create web index] ******************************************************************************************************************************** changed: [192.168.31.33] changed: [192.168.31.23]  TASK [install nginx] *********************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33]  TASK [copy config] ************************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23]  TASK [start nginx] ************************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=7 changed=6 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=7 changed=6 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证 [root@manager01 playbook]# ansible db -m shell -a 'netstat -tnulp |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:82 0.0.0.0:* LISTEN 5732/nginx: master tcp6 0 0 :::82 :::* LISTEN 5732/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:82 0.0.0.0:* LISTEN 3728/nginx: master tcp6 0 0 :::82 :::* LISTEN 3728/nginx: master  #为了方便后面的操作，先把环境还原到执行playbook之前 [root@manager01 playbook]# ansible db -m service -a 'name=nginx state=stopped' [root@manager01 playbook]# ansible db -m yum -a 'name=nginx state=absent' [root@manager01 playbook]# ansible db -m user -a 'name=www state=absent' [root@manager01 playbook]# ansible db -m file -a 'name=/etc/nginx/nginx.conf state=absent' [root@manager01 playbook]# ansible db -m file -a 'name=/data/playbook/html state=absent'  playbook中加入 gather_facts: False 不收集主机信息\n 异常中断 默认情况下，playbook在执行任务的时候，如果中间发生错误，之后的任务就不会执行。\n#新建一个nginx-1.yml，这里故意把getent写错 [root@manager01 playbook]# vim nginx-1.yml - hosts: db  remote_user: root  tasks:  - name: create www user  user: name=www system=yes uid=82 shell=/sbin/nologin  - name: test user  shell: getend passwd www  - name: create web root  file: name=/data/playbook/html state=directory  #可以看到TASK [test user]报错了，后面的任务也不会继续执行 [root@manager01 playbook]# ansible-playbook nginx-1.yml  PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [create www user] ********************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33]  TASK [test user] *************************************************************************************************************************************** fatal: [192.168.31.23]: FAILED! = {\"changed\": true, \"cmd\": \"getend passwd www\", \"delta\": \"0:00:00.008470\", \"end\": \"2023-03-20 01:33:38.950571\", \"msg\": \"non-zero return code\", \"rc\": 127, \"start\": \"2023-03-20 01:33:38.942101\", \"stderr\": \"/bin/sh: getend: 未找到命令\", \"stderr_lines\": [\"/bin/sh: getend: 未找到命令\"], \"stdout\": \"\", \"stdout_lines\": []} fatal: [192.168.31.33]: FAILED! = {\"changed\": true, \"cmd\": \"getend passwd www\", \"delta\": \"0:00:00.007368\", \"end\": \"2023-03-20 01:33:39.318020\", \"msg\": \"non-zero return code\", \"rc\": 127, \"start\": \"2023-03-20 01:33:39.310652\", \"stderr\": \"/bin/sh: getend: 未找到命令\", \"stderr_lines\": [\"/bin/sh: getend: 未找到命令\"], \"stdout\": \"\", \"stdout_lines\": []}  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=2 changed=1 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0  #想让后面的任务继续执行，可以使用ignore_errors忽略错误 [root@manager01 playbook]# vim nginx-1.yml - hosts: db  remote_user: root  tasks:  - name: create www user  user: name=www system=yes uid=82 shell=/sbin/nologin  - name: test user  shell: getend passwd www  ignore_errors: True  - name: create web root  file: name=/data/playbook/html state=directory  [root@manager01 playbook]# ansible-playbook nginx-1.yml PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [create www user] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [test user] *************************************************************************************************************************************** fatal: [192.168.31.33]: FAILED! = {\"changed\": true, \"cmd\": \"getend passwd www\", \"delta\": \"0:00:00.006418\", \"end\": \"2023-03-20 01:36:45.498078\", \"msg\": \"non-zero return code\", \"rc\": 127, \"start\": \"2023-03-20 01:36:45.491660\", \"stderr\": \"/bin/sh: getend: 未找到命令\", \"stderr_lines\": [\"/bin/sh: getend: 未找到命令\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring fatal: [192.168.31.23]: FAILED! = {\"changed\": true, \"cmd\": \"getend passwd www\", \"delta\": \"0:00:00.006048\", \"end\": \"2023-03-20 01:36:45.130733\", \"msg\": \"non-zero return code\", \"rc\": 127, \"start\": \"2023-03-20 01:36:45.124685\", \"stderr\": \"/bin/sh: getend: 未找到命令\", \"stderr_lines\": [\"/bin/sh: getend: 未找到命令\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring  TASK [create web root] ********************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=4 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=1 192.168.31.33 : ok=4 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=1 handlers 和notify搭配使用，触发handlers\n#先把nginx装上 [root@manager01 playbook]# ansible-playbook nginx.yml  #修改nginx.conf，把端口改成86 listen 86;  #执行playbook [root@manager01 playbook]# ansible-playbook nginx.yml PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [create www user] ********************************************************************************************************************************* ok: [192.168.31.33] ok: [192.168.31.23]  TASK [create web root] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [create web index] ******************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33]  TASK [install nginx] *********************************************************************************************************************************** ok: [192.168.31.23] ok: [192.168.31.33]  TASK [copy config] ************************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23]  TASK [start nginx] ************************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=7 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=7 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #发现端口没有修改，因为nginx服务并没有重启 [root@manager01 playbook]# ansible db -m shell -a 'netstat -tnulp |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:82 0.0.0.0:* LISTEN 11393/nginx: master tcp6 0 0 :::82 :::* LISTEN 11393/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:82 0.0.0.0:* LISTEN 6562/nginx: master tcp6 0 0 :::82 :::* LISTEN 6562/nginx: master  #修改playbook [root@manager01 playbook]# cp nginx.yml nginx_handlers.yml [root@manager01 playbook]# vim nginx_handlers.yml - hosts: db  remote_user: root  tasks:  - name: create www user  user: name=www system=yes uid=82 shell=/sbin/nologin  - name: create web root  file: name=/data/playbook/html state=directory  - name: create web index  shell: echo 'hello ansible' /data/playbook/html/index.html  - name: install nginx  yum: name=nginx state=present  - name: copy config  copy: src=/data/playbook/nginx.conf dest=/etc/nginx/nginx.conf  notify: restart nginx  - name: start nginx  service: name=nginx state=started enabled=yes   handlers:  - name: restart nginx  service: name=nginx state=restarted  #修改nginx.conf，把端口改成89 listen 89;  #执行playbook [root@manager01 playbook]# ansible-playbook nginx_handlers.yml PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.33] ok: [192.168.31.23]  TASK [create www user] ********************************************************************************************************************************* ok: [192.168.31.33] ok: [192.168.31.23]  TASK [create web root] ********************************************************************************************************************************* ok: [192.168.31.33] ok: [192.168.31.23]  TASK [create web index] ******************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33]  TASK [install nginx] *********************************************************************************************************************************** ok: [192.168.31.33] ok: [192.168.31.23]  TASK [copy config] ************************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23]  TASK [start nginx] ************************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  RUNNING HANDLER [restart nginx] ************************************************************************************************************************ changed: [192.168.31.33] changed: [192.168.31.23]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=8 changed=3 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=8 changed=3 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #端口已经成功修改为89 [root@manager01 playbook]# ansible db -m shell -a 'netstat -tnlup |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:89 0.0.0.0:* LISTEN 13872/nginx: master tcp6 0 0 :::89 :::* LISTEN 13872/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:89 0.0.0.0:* LISTEN 8220/nginx: master tcp6 0 0 :::89 :::* LISTEN 8220/nginx: master tags playbook里的任务有很多，只想执行某一个任务\n#查看标签 [root@manager01 playbook]# ansible-playbook nginx_handlers.yml --list-tags playbook: nginx_handlers.yml   play #1 (db): db\tTAGS: []  TASK TAGS: []  #修改playbook [root@manager01 playbook]# cp nginx_handlers.yml nginx_tags.yml [root@manager01 playbook]# vim nginx_tags.yml - hosts: db  remote_user: root  tasks:  - name: create www user  user: name=www system=yes uid=82 shell=/sbin/nologin  - name: create web root  file: name=/data/playbook/html state=directory  - name: create web index  shell: echo 'hello ansible' /data/playbook/html/index.html  - name: install nginx  yum: name=nginx state=present  - name: copy config  copy: src=/data/playbook/nginx.conf dest=/etc/nginx/nginx.conf  tags: config  notify: restart nginx  - name: start nginx  service: name=nginx state=started enabled=yes   handlers:  - name: restart nginx  service: name=nginx state=restarted  #查看标签 [root@manager01 playbook]# ansible-playbook nginx_tags.yml --list-tags playbook: nginx_tags.yml   play #1 (db): db\tTAGS: []  TASK TAGS: [config]  #修改nginx.conf中的端口号为90 listen 90;  #指定tags执行playbook [root@manager01 playbook]# ansible-playbook nginx_tags.yml -t config  PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.33] ok: [192.168.31.23]  TASK [copy config] ************************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23]  RUNNING HANDLER [restart nginx] ************************************************************************************************************************ changed: [192.168.31.33] changed: [192.168.31.23]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证 [root@manager01 playbook]# ansible db -m shell -a 'netstat -tnulp |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:90 0.0.0.0:* LISTEN 17920/nginx: master tcp6 0 0 :::90 :::* LISTEN 17920/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:90 0.0.0.0:* LISTEN 9805/nginx: master tcp6 0 0 :::90 :::* LISTEN 9805/nginx: master  同一个tags可以在不同任务中使用，可以根据tags对任务进行分组，然后playbook根据tags分组执行。\n variable ansible中常见的变量定义方式：优先级从低到高\n 目标主机默认的变量 主机清单中定义的变量 通过vars定义的变量 YAMl文件定义的变量 命令行定义的变量  默认的主机变量\n#用setup模块可以看到很多属性值 [root@manager01 playbook]# ansible localhost -m setup -a \"filter=ansible_fqdn\" localhost | SUCCESS = {  \"ansible_facts\": {  \"ansible_fqdn\": \"manager01\"  },  \"changed\": false }  #以ansible_fqdn为例子 [root@manager01 playbook]# vim vars.yml - hosts: all  remote_user: root  tasks:  - name: create log file  file: name=/tmp/{{ ansible_fqdn }}.log state=touch  #执行playbook [root@manager01 playbook]# ansible-playbook vars.yml PLAY [all] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33] ok: [192.168.31.48]  TASK [create log file] ********************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证 [root@manager01 playbook]# ansible all -m shell -a \"ls /tmp/*.log\" 192.168.31.33 | CHANGED | rc=0  /tmp/node02.log 192.168.31.23 | CHANGED | rc=0  /tmp/node01.log 192.168.31.48 | CHANGED | rc=0  /tmp/manager01.log 主机清单中定义的变量\n#普通变量 [root@manager01 playbook]# cat /etc/ansible/hosts [web] 192.168.31.48 id=48 192.168.31.23 id=23  [root@manager01 playbook]# vim vars-1.yml - hosts: web  remote_user: root  tasks:  - name: create file  file: name=/tmp/{{ id }}.txt state=touch  [root@manager01 playbook]# ansible-playbook vars-1.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.48]  TASK [create file] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  [root@manager01 playbook]# ansible web -m shell -a \"ls /tmp/*.txt\" 192.168.31.23 | CHANGED | rc=0  /tmp/23.txt 192.168.31.48 | CHANGED | rc=0  /tmp/48.txt  #公共变量 [root@manager01 playbook]# vim /etc/ansible/hosts [web] 192.168.31.48 192.168.31.23 id=23  [web:vars] id=100  #先把刚刚创建的.txt文件删掉 [root@manager01 playbook]# ansible web -m shell -a \"rm -f /tmp/*.txt\"  #执行playbook [root@manager01 playbook]# ansible-playbook vars-1.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.48]  TASK [create file] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #可以看出来普通变量的优先级要高于公共变量，与局部变量和全局变量一样的道理 [root@manager01 playbook]# ansible web -m shell -a \"ls /tmp/*.txt\" 192.168.31.23 | CHANGED | rc=0  /tmp/23.txt 192.168.31.48 | CHANGED | rc=0  /tmp/100.txt 命令行定义的变量\n[root@manager01 playbook]# vim vars-2.yml - hosts: web  remote_user: root  tasks:  - name: create file  file: name=/tmp/{{ prefix }}{{ id }}.txt state=touch  # -e 'key=value ...' [root@manager01 playbook]# ansible-playbook -e 'prefix=ansible' vars-2.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.48]  TASK [create file] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  [root@manager01 playbook]# ansible web -m shell -a \"ls /tmp/*.txt\" 192.168.31.23 | CHANGED | rc=0  /tmp/23.txt /tmp/ansible23.txt 192.168.31.48 | CHANGED | rc=0  /tmp/100.txt /tmp/ansible100.txt playbook中定义vars\n[root@manager01 playbook]# vim vars-3.yml - hosts: web  remote_user: root  vars:  - prefix: ansible  - suffix: com  tasks:  - name: create file  file: name=/tmp/{{ prefix }}{{ id }}{{ suffix }}.txt state=touch  [root@manager01 playbook]# ansible-playbook vars-3.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.48]  TASK [create file] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  [root@manager01 playbook]# ansible web -m shell -a \"ls /tmp/*.txt\" 192.168.31.23 | CHANGED | rc=0  /tmp/ansible23com.txt 192.168.31.48 | CHANGED | rc=0  /tmp/ansible100com.txt 专用文vars.yml件\n[root@manager01 playbook]# vim vars.yml - prefix: www - suffix: cn  [root@manager01 playbook]# vim vars-4.yml  - hosts: web  remote_user: root  vars_files:  - vars.yml  vars:  - prefix: ansible  - suffix: com  tasks:  - name: create file  file: name=/tmp/{{ prefix }}{{ id }}{{ suffix }}.txt state=touch   [root@manager01 playbook]# ansible-playbook vars-4.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.48]  TASK [create file] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #可以看出来vars.yml中定义的变量优先级比playbook中定义的变量要高 [root@manager01 playbook]# ansible web -m shell -a \"ls /tmp/*.txt\" 192.168.31.23 | CHANGED | rc=0  /tmp/www23cn.txt 192.168.31.48 | CHANGED | rc=0  /tmp/www100cn.txt templates 模板是一个文本文件，可以根据模版文件动态生成配置文件，以.j2结尾，存放在templates目录下。\n#定义主机清单 [root@manager01 playbook]# cat /etc/ansible/hosts [web] 192.168.31.48 192.168.31.23  [db] 192.168.31.23 nginx_port=82 192.168.31.33 nginx_port=83  #修改端口这一行，其他用默认配置即可 [root@manager01 playbook]# vim nginx.conf listen {{ nginx_port }};  #创建templates目录，把nginx.conf复制到该目录下，命名以.j2结尾 [root@manager01 playbook]# mkdir templates [root@manager01 playbook]# cp nginx.conf templates/nginx.conf.j2  [root@manager01 playbook]# tree . ├── nginx_templates.yml └── templates  └── nginx.conf.j2  #编写playbook [root@manager01 playbook]# vim nginx_templates.yml - hosts: db  remote_user: root  tasks:  - name: install nginx  yum: name=nginx state=present  - name: copy config  template: src=./templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf  notify: restart nginx  - name: start nginx  service: name=nginx state=started enabled=yes   handlers:  - name: restart nginx  service: name=nginx state=restarted  #执行playbook [root@manager01 playbook]# ansible-playbook nginx_templates.yml PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.33] ok: [192.168.31.23]  TASK [install nginx] *********************************************************************************************************************************** changed: [192.168.31.33] changed: [192.168.31.23]  TASK [copy config] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33]  TASK [start nginx] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33]  RUNNING HANDLER [restart nginx] ************************************************************************************************************************ changed: [192.168.31.23] changed: [192.168.31.33]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=5 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=5 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证 [root@manager01 playbook]# ansible db -m shell -a 'netstat -tnulp |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:92 0.0.0.0:* LISTEN 35735/nginx: master tcp6 0 0 :::92 :::* LISTEN 35735/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:91 0.0.0.0:* LISTEN 18790/nginx: master tcp6 0 0 :::91 :::* LISTEN 18790/nginx: master when #简单的例子 - hosts: db  remote_user: root  tasks:  - name: install nginx  yum: name=nginx state=present  when: ansible_os_family == \"Redhat\"  #查看cpu数量 [root@manager01 playbook]# ansible web -m setup -a 'filter=ansible_processor_vcpus' 192.168.31.23 | SUCCESS = {  \"ansible_facts\": {  \"ansible_processor_vcpus\": 1,  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false } 192.168.31.33 | SUCCESS = {  \"ansible_facts\": {  \"ansible_processor_vcpus\": 1,  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false } 192.168.31.48 | SUCCESS = {  \"ansible_facts\": {  \"ansible_processor_vcpus\": 2,  \"discovered_interpreter_python\": \"/usr/bin/python\"  },  \"changed\": false }  #修改nginx.conf.j2 worker_processes {{ ansible_processor_vcpus*2 }}; listen {{ nginx_port }};  [root@manager01 playbook]# cat /etc/ansible/hosts [web] 192.168.31.48 nginx_port=93 192.168.31.23 192.168.31.33  #编写playbook，只有当 ansible_processor_vcpus == 2 的时候使用.j2模板文件 [root@manager01 playbook]# vim nginx_templates.yml  - hosts: web  remote_user: root  tasks:  - name: install nginx  yum: name=nginx state=present  - name: copy config  template: src=./templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf  when: ansible_processor_vcpus == 2  notify: restart nginx  - name: start nginx  service: name=nginx state=started enabled=yes   handlers:  - name: restart nginx  service: name=nginx state=restarted  #可以看到TASK [copy config]中22和23的主机直接跳过了 [root@manager01 playbook]# ansible-playbook nginx_templates.yml  PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33] ok: [192.168.31.48]  TASK [install nginx] *********************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  TASK [copy config] ************************************************************************************************************************************* skipping: [192.168.31.23] skipping: [192.168.31.33] changed: [192.168.31.48]  TASK [start nginx] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  RUNNING HANDLER [restart nginx] ************************************************************************************************************************ changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 192.168.31.33 : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 192.168.31.48 : ok=5 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #22和23主机用的80端口，只有48的主机才使用了.j2模板文件 [root@manager01 playbook]# ansible web -m shell -a 'netstat -tnulp |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 4860/nginx: master tcp6 0 0 :::80 :::* LISTEN 4860/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 3379/nginx: master tcp6 0 0 :::80 :::* LISTEN 3379/nginx: master 192.168.31.48 | CHANGED | rc=0  tcp 0 0 0.0.0.0:93 0.0.0.0:* LISTEN 3918/nginx: master tcp6 0 0 :::93 :::* LISTEN 3918/nginx: master  #查看nginx.conf中的 worker_processes 参数 [root@manager01 playbook]# ansible web -m shell -a 'grep process /etc/nginx/nginx.conf' 192.168.31.33 | CHANGED | rc=0  worker_processes auto; 192.168.31.23 | CHANGED | rc=0  worker_processes auto; 192.168.31.48 | CHANGED | rc=0  worker_processes 4; with_items 循环 #创建三个用户 [root@manager01 playbook]# vim useradd.yml - hosts: db  remote_user: root  tasks:  - name: useradd user  user: name={{ item }} state=present  with_items:  - user1  - user2  - user3  [root@manager01 playbook]# ansible-playbook useradd.yml PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [useradd user] ************************************************************************************************************************************ changed: [192.168.31.23] = (item=user1) changed: [192.168.31.33] = (item=user1) changed: [192.168.31.23] = (item=user2) changed: [192.168.31.33] = (item=user2) changed: [192.168.31.23] = (item=user3) changed: [192.168.31.33] = (item=user3)  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  [root@manager01 playbook]# ansible db -m shell -a 'getent passwd |grep user' 192.168.31.23 | CHANGED | rc=0  user1:x:1001:1001::/home/user1:/bin/bash user2:x:1002:1002::/home/user2:/bin/bash user3:x:1003:1003::/home/user3:/bin/bash 192.168.31.33 | CHANGED | rc=0  rpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologin user1:x:54323:54332::/home/user1:/bin/bash user2:x:54324:54333::/home/user2:/bin/bash user3:x:54325:54334::/home/user3:/bin/bash 当每个条目都是由多个键值对组成的时候\n[root@manager01 playbook]# vim add.yml  - hosts: db  remote_user: root  tasks:  - name: create group  group: name={{ item }} state=present  with_items:  - group1  - group2  - group3  - name: create user  user: name={{ item.name }} group={{ item.group }} state=present  with_items:  - { name: 'user1', group: 'group1'}  - { name: 'user2', group: 'group2'}  - { name: 'user3', group: 'group3'}  [root@manager01 playbook]# ansible-playbook add.yml PLAY [db] **********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33]  TASK [create group] ************************************************************************************************************************************ changed: [192.168.31.23] = (item=group1) changed: [192.168.31.33] = (item=group1) changed: [192.168.31.33] = (item=group2) changed: [192.168.31.23] = (item=group2) changed: [192.168.31.33] = (item=group3) changed: [192.168.31.23] = (item=group3)  TASK [create user] ************************************************************************************************************************************* changed: [192.168.31.23] = (item={u'group': u'group1', u'name': u'user1'}) changed: [192.168.31.33] = (item={u'group': u'group1', u'name': u'user1'}) changed: [192.168.31.23] = (item={u'group': u'group2', u'name': u'user2'}) changed: [192.168.31.33] = (item={u'group': u'group2', u'name': u'user2'}) changed: [192.168.31.23] = (item={u'group': u'group3', u'name': u'user3'}) changed: [192.168.31.33] = (item={u'group': u'group3', u'name': u'user3'})  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  [root@manager01 playbook]# ansible db -m shell -a 'getent passwd |grep user' 192.168.31.23 | CHANGED | rc=0  user1:x:1001:1001::/home/user1:/bin/bash user2:x:1002:1002::/home/user2:/bin/bash user3:x:1003:1003::/home/user3:/bin/bash 192.168.31.33 | CHANGED | rc=0  rpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologin user1:x:54323:54332::/home/user1:/bin/bash user2:x:54324:54333::/home/user2:/bin/bash user3:x:54325:54334::/home/user3:/bin/bash  [root@manager01 playbook]# ansible db -m shell -a 'getent group |grep group' 192.168.31.33 | CHANGED | rc=0  group1:x:54332: group2:x:54333: group3:x:54334: 192.168.31.23 | CHANGED | rc=0  group1:x:1001: group2:x:1002: group3:x:1003: 流程控制 if\n基于nginx.conf创建一个新的配置文件，用 if 实现到每台远程主机的配置文件都不同\n#修改主机清单 [root@manager01 playbook]# vim/etc/ansible/hosts [web] 192.168.31.48 nginx_port=96 nginx_vhost=manager.test.com 192.168.31.23 nginx_port=97 192.168.31.33 nginx_vhost=node02.test.com  #修改模板文件 [root@manager01 playbook]# vim templates/nginx.conf.j2 server {  {% if nginx_port is defined %}  listen {{ nginx_port }}  {% endif %}   {%if nginx_vhost is defined %}  server_name {{ nginx_vhost }}  {% endif %}   location / {  } }  #编写playbook [root@manager01 playbook]# vim if.yml  - hosts: web  remote_user: root  tasks:  - name: nginx vhost  template: src=./templates/nginx.conf.j2 dest=/tmp/vhost.conf  #执行playbook [root@manager01 playbook]# ansible-playbook if.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33] ok: [192.168.31.48]  TASK [nginx vhost] ************************************************************************************************************************************* changed: [192.168.31.33] changed: [192.168.31.23] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证 [root@manager01 playbook]# ansible web -a 'cat /tmp/vhost.conf' 192.168.31.33 | CHANGED | rc=0  server {   server_name node02.test.com   location / {  } } 192.168.31.23 | CHANGED | rc=0  server {  listen 97    location / {  } } 192.168.31.48 | CHANGED | rc=0  server {  listen 96   server_name manager.test.com   location / {  } } for\n[root@manager01 templates]# vim /etc/ansible/hosts [web] 192.168.31.48 192.168.31.23 192.168.31.33   [root@manager01 templates]# cat nginx.conf.j2 {% for nginx_port in ports %} server {  listen {{ nginx_port }}  location / {  } } {% endfor %}  [root@manager01 playbook]# vim for.yml  - hosts: web  remote_user: root  gather_facts: False  vars:  ports:  - 100  - 101  - 102   tasks:  - name: test for  template: src=./templates/nginx.conf.j2 dest=/tmp/for.conf  #执行playbook [root@manager01 playbook]# ansible-playbook for.yml PLAY [web] *********************************************************************************************************************************************  TASK [test for] **************************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=1 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=1 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=1 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证 [root@manager01 playbook]# ansible web -a 'cat /tmp/for.conf' -l 192.168.31.23 192.168.31.23 | CHANGED | rc=0  server {  listen 100 } server {  listen 101 } server {  listen 102 } roles ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令引入即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。\nroles目录结构\nroles/  common/ # this hierarchy represents a \"role\"  tasks/ #  main.yml #  handlers/ #  main.yml #  templates/ #  ntp.conf.j2 #  files/ #  bar.txt #  foo.sh #  vars/ #  main.yml #  defaults/ #  main.yml #  meta/ #  main.yml #  library/ # roles can also include custom modules  module_utils/ # roles can also include custom module_utils  lookup_plugins/ # or other types of plugins, like lookup in this case   webtier/ # same kind of structure as \"common\" was above, done for the webtier role  monitoring/ # \"\"  fooapp/ # \"\" 通过roles的方式安装nginx\n[root@manager01 roles]# pwd /etc/ansible/roles  [root@manager01 roles]# mkdir -p nginx/{tasks,vars,templates,handlers}  #主机清单 [root@manager01 roles]# cat /etc/ansible/hosts [web] 192.168.31.48 192.168.31.23 192.168.31.33  #jinja2模板文件，修改以下两个参数 [root@manager01 roles]# vim nginx/templates/nginx.conf.j2 user www; listen {{ nginx_port }};  #工作任务文件，也可以把每个task单独写成一个yml文件 [root@manager01 roles]# cat nginx/tasks/main.yml  - name: create user  user: name=www uid=666 system=yes shell=/sbin/nologin - name: install nginx  yum: name=nginx state=present - name: install config  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf  notify: restart nginx - name: start nginx  service: name=nginx state=started enabled=yes  #变量文件 [root@manager01 roles]# cat nginx/vars/main.yml  nginx_port: 90  #触发器文件 [root@manager01 roles]# cat nginx/handlers/main.yml  - name: restart nginx  service: name=nginx state=restarted  #编写nginx_role.yml调用nginx角色 [root@manager01 roles]# cat nginx_role.yml  - hosts: web  remote_user: root  roles:  - role: nginx  #目录结构 [root@manager01 roles]# tree . ├── nginx │ ├── handlers │ │ └── main.yml │ ├── tasks │ │ └── main.yml │ ├── templates │ │ └── nginx.conf.j2 │ └── vars │ └── main.yml └── nginx_role.yml  #执行playbook [root@manager01 roles]# ansible-playbook nginx_role.yml PLAY [web] *********************************************************************************************************************************************  TASK [Gathering Facts] ********************************************************************************************************************************* ok: [192.168.31.23] ok: [192.168.31.33] ok: [192.168.31.48]  TASK [nginx : create user] ***************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  TASK [install nginx] *********************************************************************************************************************************** changed: [192.168.31.33] changed: [192.168.31.23] changed: [192.168.31.48]  TASK [nginx : install config] ************************************************************************************************************************** changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  TASK [start nginx] ************************************************************************************************************************************* changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  RUNNING HANDLER [restart nginx] ************************************************************************************************************************ changed: [192.168.31.23] changed: [192.168.31.33] changed: [192.168.31.48]  PLAY RECAP ********************************************************************************************************************************************* 192.168.31.23 : ok=6 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.33 : ok=6 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.31.48 : ok=6 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0  #验证结果 [root@manager01 roles]# ansible web -m shell -a 'netstat -tnulp |grep nginx' 192.168.31.33 | CHANGED | rc=0  tcp 0 0 0.0.0.0:90 0.0.0.0:* LISTEN 34692/nginx: master tcp6 0 0 :::90 :::* LISTEN 34692/nginx: master 192.168.31.23 | CHANGED | rc=0  tcp 0 0 0.0.0.0:90 0.0.0.0:* LISTEN 16162/nginx: master tcp6 0 0 :::90 :::* LISTEN 16162/nginx: master 192.168.31.48 | CHANGED | rc=0  tcp 0 0 0.0.0.0:90 0.0.0.0:* LISTEN 58709/nginx: master tcp6 0 0 :::90 :::* LISTEN 58709/nginx: master ","wordCount":"5001","inLanguage":"en","datePublished":"2021-09-16T22:21:29+08:00","dateModified":"2021-09-16T22:21:29+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jiayi26.github.io/posts/ansible/"},"publisher":{"@type":"Organization","name":"JIAYI's Blog","logo":{"@type":"ImageObject","url":"https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jiayi26.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jiayi26.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://jiayi26.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jiayi26.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://jiayi26.github.io/posts/>Posts</a></div><h1 class=post-title>Ansible</h1><div class=post-meta><span title="2021-09-16 22:21:29 +0800 CST">September 16, 2021</span>&nbsp;·&nbsp;24 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Pass-JIAYI%27s.github.io/post/posts/Ansible.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h3 id=ansible的概述>Ansible的概述<a hidden class=anchor aria-hidden=true href=#ansible的概述>#</a></h3><p>Ansible 是基于 Python 开发，集合了众多运维工具（puppet、cfengine、chef、func、 fabric）的优点实现了批量系统配置、批量程序部署、批量运行命令等功能的自动化运维工具。</p><p>它基于模块工作，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块。基于ssh协议来实现远程管理，不需要在被执行主机上安装代理。</p><h4 id=ansible的核心组件>Ansible的核心组件<a hidden class=anchor aria-hidden=true href=#ansible的核心组件>#</a></h4><ul><li>Ansible：核心组件</li><li>Modules：包括Ansible自带的核心模块及自定义模块</li><li>Plugins：完成模块功能的补充，包括连接插件、邮箱插件</li><li>Playbook：剧本；定义Ansible多任务配置文件，完成对主机批量部署操作</li><li>Inventory：定义Ansible管理主机的清单 /etc/ansibe/hosts</li><li>Connection Plugins：负责和被监控端实现通信</li></ul><h3 id=ansible的安装和使用>Ansible的安装和使用<a hidden class=anchor aria-hidden=true href=#ansible的安装和使用>#</a></h3><h4 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># yum install -y ansible</span>
</span></span></code></pre></div><h4 id=执行模式>执行模式<a hidden class=anchor aria-hidden=true href=#执行模式>#</a></h4><ul><li>ad-hoc模式（点对点模式）：使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。</li><li>playbook模式（剧本模式）：是Ansible主要管理方式，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。</li></ul><h4 id=ansible的配置文件>Ansible的配置文件<a hidden class=anchor aria-hidden=true href=#ansible的配置文件>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ansible<span style=color:#f92672>]</span><span style=color:#75715e># pwd</span>
</span></span><span style=display:flex><span>/etc/ansible
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ansible<span style=color:#f92672>]</span><span style=color:#75715e># vim ansible.cfg</span>
</span></span><span style=display:flex><span>inventory <span style=color:#f92672>=</span> /etc/ansible/hosts	<span style=color:#75715e>#存放主机清单的文件</span>
</span></span><span style=display:flex><span>forks <span style=color:#f92672>=</span>5						<span style=color:#75715e>#并发数，默认5</span>
</span></span><span style=display:flex><span>sudo_user <span style=color:#f92672>=</span> root				<span style=color:#75715e>#的执行用户</span>
</span></span><span style=display:flex><span>remote_port <span style=color:#f92672>=</span> 22				<span style=color:#75715e>#远程连接端口</span>
</span></span><span style=display:flex><span>host_key_checking <span style=color:#f92672>=</span> False		<span style=color:#75715e>#关闭之后第一次连接的远程主机不用输入yes</span>
</span></span><span style=display:flex><span>log_path <span style=color:#f92672>=</span> /var/log/ansible.log	<span style=color:#75715e>#存放日志的文件</span>
</span></span></code></pre></div><h4 id=inventory>Inventory<a hidden class=anchor aria-hidden=true href=#inventory>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#/etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ansible<span style=color:#f92672>]</span><span style=color:#75715e># vim hosts</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ex 1: Ungrouped hosts, specify before any group headers.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## green.example.com</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## blue.example.com</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 192.168.100.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 192.168.100.10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ex 2: A collection of hosts belonging to the &#39;webservers&#39; group</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## [webservers]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## alpha.example.org</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## beta.example.org</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 192.168.1.100</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 192.168.1.110</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># If you have multiple hosts following a pattern you can specify</span>
</span></span><span style=display:flex><span><span style=color:#75715e># them like this:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## www[001:006].example.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ex 3: A collection of database servers in the &#39;dbservers&#39; group</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## [dbservers]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## </span>
</span></span><span style=display:flex><span><span style=color:#75715e>## db01.intranet.mydomain.net</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## db02.intranet.mydomain.net</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 10.25.1.56</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 10.25.1.57</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Here&#39;s another example of host ranges, this time there are no</span>
</span></span><span style=display:flex><span><span style=color:#75715e># leading 0s:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## db-[99:101]-node.example.com</span>
</span></span></code></pre></div><p>方括号[]中是组名，用于对系统进行分类，便于对不同系统进行个别的管理。</p><p>一个系统可以属于不同的组，比如一台服务器可以同时属于 webserver组 和 dbserver组.这时属于两个组的变量都可以为这台主机所用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#如果有主机的SSH端口不是标准的22端口，可在主机名之后加上端口号，用冒号分隔，如：</span>
</span></span><span style=display:flex><span>192.168.1.100:6666
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#一组相似的 hostname , 可简写成如下：</span>
</span></span><span style=display:flex><span>www<span style=color:#f92672>[</span>001:006<span style=color:#f92672>]</span>.example.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#定义字母范围的简写模式</span>
</span></span><span style=display:flex><span>db-<span style=color:#f92672>[</span>99:101<span style=color:#f92672>]</span>-node.example.com
</span></span></code></pre></div><p><strong>主机变量</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>webservers<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.1.100 http_port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>192.168.1.110 http_port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p><strong>组的变量</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#定义整个组的变量</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>webservers<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.1.100
</span></span><span style=display:flex><span>192.168.1.110
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>webservers:vars<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>http_port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span>
</span></span></code></pre></div><p><strong>把一个组作为另一个组的子成员</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>webservers<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.1.100
</span></span><span style=display:flex><span>192.168.1.110
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>dbservers<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.1.180
</span></span><span style=display:flex><span>192.168.1.190
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>general:children<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>webservers
</span></span><span style=display:flex><span>dbservers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>general:vars<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>gather_timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>connect_timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>
</span></span></code></pre></div><p><strong>分文件定义 Host 和 Group 变量</strong></p><p>在 inventory 主文件中保存所有的变量并不是最佳的方式。还可以保存在独立的文件中，这些独立文件与 inventory 文件保持关联。不同于 inventory 文件(INI 格式)，这些独立文件的格式为 YAML。</p><p>假设有一个主机名为 foosball，主机同时属于两个组,一个是 raleigh， 另一个是 webservers。那么以下配置文件(YAML 格式)中的变量可以为 foosball主机所用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/etc/ansible/group_vars/dbservers
</span></span><span style=display:flex><span>/etc/ansible/group_vars/webservers
</span></span><span style=display:flex><span>/etc/ansible/host_vars/foosball
</span></span></code></pre></div><p>还可以为一个主机,或一个组，创建一个目录，目录名就是主机名或组名。目录中的可以创建多个文件，文件中的变量都会被读取为主机或组的变量。</p><pre tabindex=0><code>/etc/ansible/group_vars/dbservers/db_settings
/etc/ansible/group_vars/dbservers/cluster_settings
</code></pre><blockquote><p>Ansible 1.2 及以上的版本中，group_vars/ 和 host_vars/ 目录可放在 inventory 目录下，或是 playbook 目录下。如果两个目录下都存在，那么 playbook 目录下的配置会覆盖 inventory 目录的配置。</p></blockquote><h3 id=ad-hoc-命令的介绍>Ad-Hoc 命令的介绍<a hidden class=anchor aria-hidden=true href=#ad-hoc-命令的介绍>#</a></h3><h4 id=ssh免密登录>ssh免密登录<a hidden class=anchor aria-hidden=true href=#ssh免密登录>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#生成密钥，过程直接输入回车即可</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ssh-keygen -t rsa</span>
</span></span><span style=display:flex><span>Generating public/private rsa key pair.
</span></span><span style=display:flex><span>Enter file in which to save the key <span style=color:#f92672>(</span>/root/.ssh/id_rsa<span style=color:#f92672>)</span>: 
</span></span><span style=display:flex><span>Enter passphrase <span style=color:#f92672>(</span>empty <span style=color:#66d9ef>for</span> no passphrase<span style=color:#f92672>)</span>: 
</span></span><span style=display:flex><span>Enter same passphrase again: 
</span></span><span style=display:flex><span>Your identification has been saved in /root/.ssh/id_rsa.
</span></span><span style=display:flex><span>Your public key has been saved in /root/.ssh/id_rsa.pub.
</span></span><span style=display:flex><span>The key fingerprint is:
</span></span><span style=display:flex><span>SHA256:kx03zvb/XtCE94TMRlL4rRRdC+/PGetBuhZwFW1zpjE root@manager01
</span></span><span style=display:flex><span>The key<span style=color:#960050;background-color:#1e0010>&#39;</span>s randomart image is:
</span></span><span style=display:flex><span>+---<span style=color:#f92672>[</span>RSA 2048<span style=color:#f92672>]</span>----+
</span></span><span style=display:flex><span>|            .+oo<span style=color:#f92672>=</span>|
</span></span><span style=display:flex><span>|            .<span style=color:#f92672>=</span>E<span style=color:#f92672>=</span>B|
</span></span><span style=display:flex><span>|          . o.B@*|
</span></span><span style=display:flex><span>|         o * +<span style=color:#f92672>==</span>o|
</span></span><span style=display:flex><span>|        S . *..<span style=color:#f92672>=</span>o|
</span></span><span style=display:flex><span>|         . . o+o<span style=color:#f92672>=</span>|
</span></span><span style=display:flex><span>|             .o++|
</span></span><span style=display:flex><span>|             .o.o|
</span></span><span style=display:flex><span>|            .. o<span style=color:#f92672>=</span>|
</span></span><span style=display:flex><span>+----<span style=color:#f92672>[</span>SHA256<span style=color:#f92672>]</span>-----+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#把公钥分发到其他主机</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ssh-copy-id 192.168.31.23</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ssh-copy-id 192.168.31.33</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#先配置好hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># vim /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>192.168.31.23
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48
</span></span><span style=display:flex><span>192.168.31.23
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>db<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.23
</span></span><span style=display:flex><span>192.168.31.33
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>storage<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.33
</span></span><span style=display:flex><span>192.168.31.48
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all -m ping</span>
</span></span><span style=display:flex><span>192.168.31.33 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>192.168.31.23 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>192.168.31.48 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=常用模块介绍>常用模块介绍<a hidden class=anchor aria-hidden=true href=#常用模块介绍>#</a></h4><p><strong>command</strong>：ansible默认模块，用于执行Linux基础命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible-doc command -s</span>
</span></span><span style=display:flex><span>- name: Execute commands on targets
</span></span><span style=display:flex><span>  command:
</span></span><span style=display:flex><span>      argv:                  <span style=color:#75715e># Passes the command as a list rather than a string. Use `argv&#39; to avoid quoting values that would otherwise be</span>
</span></span><span style=display:flex><span>                               interpreted incorrectly <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> example <span style=color:#e6db74>&#34;user name&#34;</span><span style=color:#f92672>)</span>. Only the string or the list form can
</span></span><span style=display:flex><span>                               be provided, not both.  One or the other must be provided.
</span></span><span style=display:flex><span>      chdir:                 <span style=color:#75715e># Change into this directory before running the command.</span>
</span></span><span style=display:flex><span>      cmd:                   <span style=color:#75715e># The command to run.</span>
</span></span><span style=display:flex><span>      creates:               <span style=color:#75715e># A filename or (since 2.0) glob pattern. If it already exists, this step *won&#39;t* be run.</span>
</span></span><span style=display:flex><span>      free_form:             <span style=color:#75715e># The command module takes a free form command to run. There is no actual parameter named &#39;free form&#39;.</span>
</span></span><span style=display:flex><span>      removes:               <span style=color:#75715e># A filename or (since 2.0) glob pattern. If it already exists, this step *will* be run.</span>
</span></span><span style=display:flex><span>      stdin:                 <span style=color:#75715e># Set the stdin of the command directly to the specified value.</span>
</span></span><span style=display:flex><span>      stdin_add_newline:     <span style=color:#75715e># If set to `yes&#39;, append a newline to stdin data.</span>
</span></span><span style=display:flex><span>      strip_empty_ends:      <span style=color:#75715e># Strip empty lines from the end of stdout/stderr in result.</span>
</span></span><span style=display:flex><span>      warn:                  <span style=color:#75715e># Enable or disable task warnings.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#-m不写默认就是用command模块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m command -a &#34;ls&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>anaconda-ks.cfg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -a &#34;chdir=/tmp pwd&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp
</span></span></code></pre></div><p><strong>shell</strong>：和command相似，shell支持特殊字符</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m shell -a &#39;env |grep SHELL&#39; </span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>SHELL<span style=color:#f92672>=</span>/bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@node01 tmp<span style=color:#f92672>]</span><span style=color:#75715e># vi test.sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;hello ansible&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m shell -a &#34;/bin/bash /tmp/test.sh&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello ansible
</span></span></code></pre></div><p><strong>script</strong>：在远程主机上运行ansible服务器上的脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 tmp<span style=color:#f92672>]</span><span style=color:#75715e># cat scripts.sh </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;hello ansible&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m script -a &#34;/tmp/scripts.sh&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rc&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;Shared connection to 192.168.31.23 closed.\r\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Shared connection to 192.168.31.23 closed.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;hello ansible\r\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hello ansible&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>user</strong>：管理用户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#创建一个系统用户web，属组是root，uid=10086，禁止登录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m user -a &#34;name=web system=yes groups=root uid=10086 shell=/sbin/nologin state=present&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;comment&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;create_home&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;group&#34;</span>: 993, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;groups&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;home&#34;</span>: <span style=color:#e6db74>&#34;/home/web&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;web&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;shell&#34;</span>: <span style=color:#e6db74>&#34;/sbin/nologin&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;present&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;system&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;uid&#34;</span>: <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -a &#34;id web&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>10086<span style=color:#f92672>(</span>web<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>993<span style=color:#f92672>(</span>web<span style=color:#f92672>)</span> 组<span style=color:#f92672>=</span>993<span style=color:#f92672>(</span>web<span style=color:#f92672>)</span>,0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#删除用户</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m user -a &#34;name=web state=absent remove=yes&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;force&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;web&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;remove&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;absent&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;userdel: web 邮件池 (/var/spool/mail/web) 未找到\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;userdel: web 邮件池 (/var/spool/mail/web) 未找到&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -a &#34;id web&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | FAILED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> &gt;&gt;
</span></span><span style=display:flex><span>id: web: no such usernon-zero <span style=color:#66d9ef>return</span> code
</span></span></code></pre></div><p><strong>group</strong>：管理组</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#创建组web，gid=10086</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m group -a &#34;name=web system=yes gid=10086 state=present&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;gid&#34;</span>: 10086, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;web&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;present&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;system&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -a &#34;getent group web&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>web:x:10086:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#删除组</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m group -a &#34;name=web state=absent&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;web&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -a &#34;getent group web&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | FAILED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> &gt;&gt;
</span></span><span style=display:flex><span>non-zero <span style=color:#66d9ef>return</span> code
</span></span></code></pre></div><p><strong>setup</strong>：收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m setup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#筛选需要的信息</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m setup -a &#34;filter=ansible_hostname&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_hostname&#34;</span>: <span style=color:#e6db74>&#34;node01&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m setup -a &#34;filter=ansible_default_ipv4&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_default_ipv4&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;192.168.31.23&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;alias&#34;</span>: <span style=color:#e6db74>&#34;ens33&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;broadcast&#34;</span>: <span style=color:#e6db74>&#34;192.168.31.255&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;gateway&#34;</span>: <span style=color:#e6db74>&#34;192.168.31.1&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;interface&#34;</span>: <span style=color:#e6db74>&#34;ens33&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;macaddress&#34;</span>: <span style=color:#e6db74>&#34;00:0c:29:1b:07:16&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;mtu&#34;</span>: 1500, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;netmask&#34;</span>: <span style=color:#e6db74>&#34;255.255.255.0&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;192.168.31.0&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;ether&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>copy</strong>：复制文件到远程主机</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 tmp<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m copy -a &#34;src=/tmp/scripts.sh dest=/tmp/scripts.sh backup=yes&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;checksum&#34;</span>: <span style=color:#e6db74>&#34;6e979f8744e8e0b07fa3db3a0d41081241ef3feb&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;dest&#34;</span>: <span style=color:#e6db74>&#34;/tmp/scripts.sh&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;gid&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;md5sum&#34;</span>: <span style=color:#e6db74>&#34;ed1cd6048daee9ff5a8e031a09adb182&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;0644&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;secontext&#34;</span>: <span style=color:#e6db74>&#34;unconfined_u:object_r:admin_home_t:s0&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;size&#34;</span>: 33, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;src&#34;</span>: <span style=color:#e6db74>&#34;/root/.ansible/tmp/ansible-tmp-1679005928.95-69209-264876077265452/source&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;file&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;uid&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>fetch</strong>：从远程主机提取文件至ansible服务器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 tmp<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m fetch -a &#34;src=/tmp/test.sh dest=/tmp&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;checksum&#34;</span>: <span style=color:#e6db74>&#34;6e979f8744e8e0b07fa3db3a0d41081241ef3feb&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;dest&#34;</span>: <span style=color:#e6db74>&#34;/tmp/192.168.31.23/tmp/test.sh&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;md5sum&#34;</span>: <span style=color:#e6db74>&#34;ed1cd6048daee9ff5a8e031a09adb182&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;remote_checksum&#34;</span>: <span style=color:#e6db74>&#34;6e979f8744e8e0b07fa3db3a0d41081241ef3feb&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;remote_md5sum&#34;</span>: null
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#会看到一个一ip命名的文件夹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 tmp<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>192.168.31.23  scripts.sh
</span></span></code></pre></div><p><strong>file</strong>：设置文件属性，创建目录、文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#创建目录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m file -a &#34;path=/file state=directory&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;gid&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;0755&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/file&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;secontext&#34;</span>: <span style=color:#e6db74>&#34;unconfined_u:object_r:default_t:s0&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;size&#34;</span>: 6, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;directory&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;uid&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#创建文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m file -a &#34;path=/file/file.txt state=touch&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;dest&#34;</span>: <span style=color:#e6db74>&#34;/file/file.txt&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;gid&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;0644&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;secontext&#34;</span>: <span style=color:#e6db74>&#34;unconfined_u:object_r:default_t:s0&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;size&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;file&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;uid&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>stat</strong>：查看文件的属性状态</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m stat -a &#34;path=/file/file.txt&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stat&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;atime&#34;</span>: 1678991161.9935107, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;attr_flags&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;attributes&#34;</span>: <span style=color:#f92672>[]</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;block_size&#34;</span>: 4096, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;blocks&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;charset&#34;</span>: <span style=color:#e6db74>&#34;binary&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;checksum&#34;</span>: <span style=color:#e6db74>&#34;da39a3ee5e6b4b0d3255bfef95601890afd80709&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ctime&#34;</span>: 1678991161.9935107, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dev&#34;</span>: 64768, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;device_type&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;executable&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;exists&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gid&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gr_name&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;inode&#34;</span>: 1787370, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isblk&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ischr&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isdir&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isfifo&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isgid&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;islnk&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isreg&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;issock&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isuid&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mimetype&#34;</span>: <span style=color:#e6db74>&#34;inode/x-empty&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;0644&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mtime&#34;</span>: 1678991161.9935107, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nlink&#34;</span>: 1, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/file/file.txt&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;pw_name&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;readable&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rgrp&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;roth&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rusr&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;size&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;uid&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;18446744073193559713&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;wgrp&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;woth&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;writeable&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;wusr&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xgrp&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xoth&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xusr&#34;</span>: false
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>yum</strong>：管理软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#查看软件包</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m yum -a &#34;list=nginx&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;results&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;arch&#34;</span>: <span style=color:#e6db74>&#34;x86_64&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;envra&#34;</span>: <span style=color:#e6db74>&#34;1:nginx-1.20.1-10.el7.x86_64&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;epoch&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;nginx&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;release&#34;</span>: <span style=color:#e6db74>&#34;10.el7&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;repo&#34;</span>: <span style=color:#e6db74>&#34;epel&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.20.1&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;yumstate&#34;</span>: <span style=color:#e6db74>&#34;available&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#安装软件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m yum -a &#34;name=nginx state=present&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#卸载软件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m yum -a &#34;name=nginx state=absent&#34;</span>
</span></span></code></pre></div><p><strong>service</strong>：管理服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#启动nginx，设置开启自启，state=restarted重启服务，state=stopped停止服务，state=reloded，重新加载</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m service -a &#34;name=nginx state=started enabled=yes&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;enabled&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;nginx&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;started&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#f92672>{</span>
</span></span></code></pre></div><h3 id=playbook-剧本>playbook 剧本<a hidden class=anchor aria-hidden=true href=#playbook-剧本>#</a></h3><h4 id=playbook的核心元素>playbook的核心元素<a hidden class=anchor aria-hidden=true href=#playbook的核心元素>#</a></h4><ul><li><code>Hosts</code> 执行的远程主机列表</li><li><code>Tasks</code> 任务集</li><li><code>Varniables</code> 内置变量或自定义变量在playbook中调用</li><li><code>Templates</code> 模板，即使用模板语法的文件，比如配置文件等</li><li><code>Handlers</code> 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li><code>Tags</code> 标签，指定某条任务执行，用于选择运行playbook中的部分代码</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m yum -a &#34;name=nginx state=present&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.31.23 -m service -a &#34;name=nginx state=started enabled=yes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#现在把以上两条命令写成playbook</span>
</span></span><span style=display:flex><span>- hosts: 192.168.31.23
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>    - name: start nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>#综合以上创建一个playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create www user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>=</span>www system<span style=color:#f92672>=</span>yes uid<span style=color:#f92672>=</span><span style=color:#ae81ff>82</span> shell<span style=color:#f92672>=</span>/sbin/nologin
</span></span><span style=display:flex><span>    - name: create web root
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/data/playbook/html state<span style=color:#f92672>=</span>directory
</span></span><span style=display:flex><span>    - name: create web index
</span></span><span style=display:flex><span>      shell: echo <span style=color:#e6db74>&#39;&lt;h1&gt;hello ansible&lt;/h1&gt;&#39;</span> &gt;/data/playbook/html/index.html
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>    - name: copy config
</span></span><span style=display:flex><span>      copy: src<span style=color:#f92672>=</span>/data/playbook/nginx.conf dest<span style=color:#f92672>=</span>/etc/nginx/nginx.conf
</span></span><span style=display:flex><span>    - name: start nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#75715e>#检查语法 --syntax-check</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx.yml --syntax-check</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: nginx.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#模拟执行playbook -C</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx.yml -C</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create www user<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web root<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web index<span style=color:#f92672>]</span> ********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>install nginx<span style=color:#f92672>]</span> ***********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>copy config<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>start nginx<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;netstat -tnulp |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:82              0.0.0.0:*               LISTEN      5732/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::82                   :::*                    LISTEN      5732/nginx: master  
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:82              0.0.0.0:*               LISTEN      3728/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::82                   :::*                    LISTEN      3728/nginx: master
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#为了方便后面的操作，先把环境还原到执行playbook之前</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m service -a &#39;name=nginx state=stopped&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m yum -a &#39;name=nginx state=absent&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m user -a &#39;name=www state=absent&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m file -a &#39;name=/etc/nginx/nginx.conf state=absent&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m file -a &#39;name=/data/playbook/html state=absent&#39;</span>
</span></span></code></pre></div><blockquote><p>playbook中加入 gather_facts: False 不收集主机信息</p></blockquote><h4 id=异常中断>异常中断<a hidden class=anchor aria-hidden=true href=#异常中断>#</a></h4><p>默认情况下，playbook在执行任务的时候，如果中间发生错误，之后的任务就不会执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#新建一个nginx-1.yml，这里故意把getent写错</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx-1.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create www user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>=</span>www system<span style=color:#f92672>=</span>yes uid<span style=color:#f92672>=</span><span style=color:#ae81ff>82</span> shell<span style=color:#f92672>=</span>/sbin/nologin
</span></span><span style=display:flex><span>    - name: test user
</span></span><span style=display:flex><span>      shell: getend passwd www
</span></span><span style=display:flex><span>    - name: create web root
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/data/playbook/html state<span style=color:#f92672>=</span>directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#可以看到TASK [test user]报错了，后面的任务也不会继续执行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx-1.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create www user<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>test user<span style=color:#f92672>]</span> ***************************************************************************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;getend passwd www&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.008470&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:33:38.950571&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 127, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:33:38.942101&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;getend passwd www&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.007368&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:33:39.318020&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 127, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:33:39.310652&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#想让后面的任务继续执行，可以使用ignore_errors忽略错误</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx-1.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create www user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>=</span>www system<span style=color:#f92672>=</span>yes uid<span style=color:#f92672>=</span><span style=color:#ae81ff>82</span> shell<span style=color:#f92672>=</span>/sbin/nologin
</span></span><span style=display:flex><span>    - name: test user
</span></span><span style=display:flex><span>      shell: getend passwd www
</span></span><span style=display:flex><span>      ignore_errors: True
</span></span><span style=display:flex><span>    - name: create web root
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/data/playbook/html state<span style=color:#f92672>=</span>directory
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx-1.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create www user<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>test user<span style=color:#f92672>]</span> ***************************************************************************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;getend passwd www&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.006418&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:36:45.498078&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 127, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:36:45.491660&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>...ignoring
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;getend passwd www&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.006048&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:36:45.130733&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 127, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-03-20 01:36:45.124685&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/sh: getend: 未找到命令&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>...ignoring
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web root<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h4 id=handlers>handlers<a hidden class=anchor aria-hidden=true href=#handlers>#</a></h4><p>和notify搭配使用，触发handlers</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#先把nginx装上</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改nginx.conf，把端口改成86</span>
</span></span><span style=display:flex><span>listen       86;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create www user<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web root<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web index<span style=color:#f92672>]</span> ********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>install nginx<span style=color:#f92672>]</span> ***********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>copy config<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>start nginx<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#发现端口没有修改，因为nginx服务并没有重启</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;netstat -tnulp |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:82              0.0.0.0:*               LISTEN      11393/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::82                   :::*                    LISTEN      11393/nginx: master 
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:82              0.0.0.0:*               LISTEN      6562/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::82                   :::*                    LISTEN      6562/nginx: master
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cp nginx.yml nginx_handlers.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx_handlers.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create www user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>=</span>www system<span style=color:#f92672>=</span>yes uid<span style=color:#f92672>=</span><span style=color:#ae81ff>82</span> shell<span style=color:#f92672>=</span>/sbin/nologin
</span></span><span style=display:flex><span>    - name: create web root
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/data/playbook/html state<span style=color:#f92672>=</span>directory
</span></span><span style=display:flex><span>    - name: create web index
</span></span><span style=display:flex><span>      shell: echo <span style=color:#e6db74>&#39;&lt;h1&gt;hello ansible&lt;/h1&gt;&#39;</span> &gt;/data/playbook/html/index.html
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>    - name: copy config
</span></span><span style=display:flex><span>      copy: src<span style=color:#f92672>=</span>/data/playbook/nginx.conf dest<span style=color:#f92672>=</span>/etc/nginx/nginx.conf
</span></span><span style=display:flex><span>      notify: restart nginx
</span></span><span style=display:flex><span>    - name: start nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: restart nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>restarted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改nginx.conf，把端口改成89</span>
</span></span><span style=display:flex><span>listen       89;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_handlers.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create www user<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web root<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create web index<span style=color:#f92672>]</span> ********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>install nginx<span style=color:#f92672>]</span> ***********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>copy config<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>start nginx<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>restart nginx<span style=color:#f92672>]</span> ************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#端口已经成功修改为89</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;netstat -tnlup |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:89              0.0.0.0:*               LISTEN      13872/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::89                   :::*                    LISTEN      13872/nginx: master 
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:89              0.0.0.0:*               LISTEN      8220/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::89                   :::*                    LISTEN      8220/nginx: master
</span></span></code></pre></div><h4 id=tags>tags<a hidden class=anchor aria-hidden=true href=#tags>#</a></h4><p>playbook里的任务有很多，只想执行某一个任务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#查看标签</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_handlers.yml --list-tags</span>
</span></span><span style=display:flex><span>playbook: nginx_handlers.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (db): db	TAGS: []</span>
</span></span><span style=display:flex><span>      TASK TAGS: <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span><span style=color:#75715e>#修改playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cp nginx_handlers.yml nginx_tags.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx_tags.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create www user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>=</span>www system<span style=color:#f92672>=</span>yes uid<span style=color:#f92672>=</span><span style=color:#ae81ff>82</span> shell<span style=color:#f92672>=</span>/sbin/nologin
</span></span><span style=display:flex><span>    - name: create web root
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/data/playbook/html state<span style=color:#f92672>=</span>directory
</span></span><span style=display:flex><span>    - name: create web index
</span></span><span style=display:flex><span>      shell: echo <span style=color:#e6db74>&#39;&lt;h1&gt;hello ansible&lt;/h1&gt;&#39;</span> &gt;/data/playbook/html/index.html
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>    - name: copy config
</span></span><span style=display:flex><span>      copy: src<span style=color:#f92672>=</span>/data/playbook/nginx.conf dest<span style=color:#f92672>=</span>/etc/nginx/nginx.conf
</span></span><span style=display:flex><span>      tags: config
</span></span><span style=display:flex><span>      notify: restart nginx
</span></span><span style=display:flex><span>    - name: start nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: restart nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>restarted
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#75715e>#查看标签</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_tags.yml --list-tags</span>
</span></span><span style=display:flex><span>playbook: nginx_tags.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (db): db	TAGS: []</span>
</span></span><span style=display:flex><span>      TASK TAGS: <span style=color:#f92672>[</span>config<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#75715e>#修改nginx.conf中的端口号为90</span>
</span></span><span style=display:flex><span>listen       90;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#指定tags执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_tags.yml -t config</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>copy config<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>restart nginx<span style=color:#f92672>]</span> ************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;netstat -tnulp |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:90              0.0.0.0:*               LISTEN      17920/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::90                   :::*                    LISTEN      17920/nginx: master 
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:90              0.0.0.0:*               LISTEN      9805/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::90                   :::*                    LISTEN      9805/nginx: master
</span></span></code></pre></div><blockquote><p>同一个tags可以在不同任务中使用，可以根据tags对任务进行分组，然后playbook根据tags分组执行。</p></blockquote><h4 id=variable>variable<a hidden class=anchor aria-hidden=true href=#variable>#</a></h4><p>ansible中常见的变量定义方式：优先级从低到高</p><ul><li>目标主机默认的变量</li><li>主机清单中定义的变量</li><li>通过vars定义的变量</li><li>YAMl文件定义的变量</li><li>命令行定义的变量</li></ul><p><strong>默认的主机变量</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#用setup模块可以看到很多属性值</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m setup -a &#34;filter=ansible_fqdn&#34;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_fqdn&#34;</span>: <span style=color:#e6db74>&#34;manager01&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#以ansible_fqdn为例子</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim vars.yml</span>
</span></span><span style=display:flex><span>- hosts: all
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create log file
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/tmp/<span style=color:#f92672>{{</span> ansible_fqdn <span style=color:#f92672>}}</span>.log state<span style=color:#f92672>=</span>touch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook vars.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>all<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create log file<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible all -m shell -a &#34;ls /tmp/*.log&#34;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/node02.log
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/node01.log
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/manager01.log
</span></span></code></pre></div><p><strong>主机清单中定义的变量</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#普通变量</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48 id<span style=color:#f92672>=</span><span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>192.168.31.23 id<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim vars-1.yml</span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create file
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/tmp/<span style=color:#f92672>{{</span> id <span style=color:#f92672>}}</span>.txt state<span style=color:#f92672>=</span>touch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook vars-1.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create file<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#34;ls /tmp/*.txt&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/23.txt
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/48.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#公共变量</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48
</span></span><span style=display:flex><span>192.168.31.23 id<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web:vars<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>id<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#先把刚刚创建的.txt文件删掉</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#34;rm -f /tmp/*.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook vars-1.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create file<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#可以看出来普通变量的优先级要高于公共变量，与局部变量和全局变量一样的道理</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#34;ls /tmp/*.txt&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/23.txt
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/100.txt
</span></span></code></pre></div><p><strong>命令行定义的变量</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim vars-2.yml</span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create file
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/tmp/<span style=color:#f92672>{{</span> prefix <span style=color:#f92672>}}{{</span> id <span style=color:#f92672>}}</span>.txt state<span style=color:#f92672>=</span>touch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># -e &#39;key=value ...&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -e &#39;prefix=ansible&#39; vars-2.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create file<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#34;ls /tmp/*.txt&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/23.txt
</span></span><span style=display:flex><span>/tmp/ansible23.txt
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/100.txt
</span></span><span style=display:flex><span>/tmp/ansible100.txt
</span></span></code></pre></div><p><strong>playbook中定义vars</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim vars-3.yml</span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    - prefix: ansible
</span></span><span style=display:flex><span>    - suffix: com
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create file
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/tmp/<span style=color:#f92672>{{</span> prefix <span style=color:#f92672>}}{{</span> id <span style=color:#f92672>}}{{</span> suffix <span style=color:#f92672>}}</span>.txt state<span style=color:#f92672>=</span>touch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook vars-3.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create file<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#34;ls /tmp/*.txt&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/ansible23com.txt
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/ansible100com.txt
</span></span></code></pre></div><p><strong>专用文vars.yml件</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim vars.yml</span>
</span></span><span style=display:flex><span>- prefix: www
</span></span><span style=display:flex><span>- suffix: cn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim vars-4.yml </span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  vars_files:
</span></span><span style=display:flex><span>    - vars.yml
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    - prefix: ansible
</span></span><span style=display:flex><span>    - suffix: com
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create file
</span></span><span style=display:flex><span>      file: name<span style=color:#f92672>=</span>/tmp/<span style=color:#f92672>{{</span> prefix <span style=color:#f92672>}}{{</span> id <span style=color:#f92672>}}{{</span> suffix <span style=color:#f92672>}}</span>.txt state<span style=color:#f92672>=</span>touch
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook vars-4.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create file<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#可以看出来vars.yml中定义的变量优先级比playbook中定义的变量要高</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#34;ls /tmp/*.txt&#34;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/www23cn.txt
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/www100cn.txt
</span></span></code></pre></div><h4 id=templates>templates<a hidden class=anchor aria-hidden=true href=#templates>#</a></h4><p>模板是一个文本文件，可以根据模版文件动态生成配置文件，以<code>.j2</code>结尾，存放在templates目录下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#定义主机清单</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48
</span></span><span style=display:flex><span>192.168.31.23 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>db<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.23 nginx_port<span style=color:#f92672>=</span><span style=color:#ae81ff>82</span>
</span></span><span style=display:flex><span>192.168.31.33 nginx_port<span style=color:#f92672>=</span><span style=color:#ae81ff>83</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改端口这一行，其他用默认配置即可</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx.conf</span>
</span></span><span style=display:flex><span>listen       <span style=color:#f92672>{{</span> nginx_port <span style=color:#f92672>}}</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#创建templates目录，把nginx.conf复制到该目录下，命名以.j2结尾</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># mkdir templates</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cp nginx.conf templates/nginx.conf.j2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># tree</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── nginx_templates.yml
</span></span><span style=display:flex><span>└── templates
</span></span><span style=display:flex><span>    └── nginx.conf.j2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#编写playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx_templates.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>    - name: copy config
</span></span><span style=display:flex><span>      template: src<span style=color:#f92672>=</span>./templates/nginx.conf.j2 dest<span style=color:#f92672>=</span>/etc/nginx/nginx.conf
</span></span><span style=display:flex><span>      notify: restart nginx
</span></span><span style=display:flex><span>    - name: start nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: restart nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>restarted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_templates.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>install nginx<span style=color:#f92672>]</span> ***********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>copy config<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>start nginx<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>restart nginx<span style=color:#f92672>]</span> ************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;netstat -tnulp |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:92              0.0.0.0:*               LISTEN      35735/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::92                   :::*                    LISTEN      35735/nginx: master 
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:91              0.0.0.0:*               LISTEN      18790/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::91                   :::*                    LISTEN      18790/nginx: master
</span></span></code></pre></div><h5 id=when>when<a hidden class=anchor aria-hidden=true href=#when>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#简单的例子</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>      when: ansible_os_family <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Redhat&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看cpu数量</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m setup -a &#39;filter=ansible_processor_vcpus&#39;</span>
</span></span><span style=display:flex><span>192.168.31.23 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_processor_vcpus&#34;</span>: 1, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>192.168.31.33 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_processor_vcpus&#34;</span>: 1, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>192.168.31.48 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_processor_vcpus&#34;</span>: 2, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改nginx.conf.j2</span>
</span></span><span style=display:flex><span>worker_processes <span style=color:#f92672>{{</span> ansible_processor_vcpus*2 <span style=color:#f92672>}}</span>;
</span></span><span style=display:flex><span>listen       <span style=color:#f92672>{{</span> nginx_port <span style=color:#f92672>}}</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48 nginx_port<span style=color:#f92672>=</span><span style=color:#ae81ff>93</span>
</span></span><span style=display:flex><span>192.168.31.23
</span></span><span style=display:flex><span>192.168.31.33
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#编写playbook，只有当 ansible_processor_vcpus == 2 的时候使用.j2模板文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx_templates.yml </span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: install nginx
</span></span><span style=display:flex><span>      yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>    - name: copy config
</span></span><span style=display:flex><span>      template: src<span style=color:#f92672>=</span>./templates/nginx.conf.j2 dest<span style=color:#f92672>=</span>/etc/nginx/nginx.conf
</span></span><span style=display:flex><span>      when: ansible_processor_vcpus <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      notify: restart nginx
</span></span><span style=display:flex><span>    - name: start nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: restart nginx
</span></span><span style=display:flex><span>      service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>restarted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#可以看到TASK [copy config]中22和23的主机直接跳过了</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_templates.yml </span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>install nginx<span style=color:#f92672>]</span> ***********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>copy config<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>start nginx<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>restart nginx<span style=color:#f92672>]</span> ************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#22和23主机用的80端口，只有48的主机才使用了.j2模板文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#39;netstat -tnulp |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      4860/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::80                   :::*                    LISTEN      4860/nginx: master  
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      3379/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::80                   :::*                    LISTEN      3379/nginx: master  
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:93              0.0.0.0:*               LISTEN      3918/nginx: master  
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::93                   :::*                    LISTEN      3918/nginx: master
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看nginx.conf中的 worker_processes 参数</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#39;grep process /etc/nginx/nginx.conf&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>worker_processes auto;
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>worker_processes auto;
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>worker_processes 4;
</span></span></code></pre></div><h5 id=with_items-循环>with_items 循环<a hidden class=anchor aria-hidden=true href=#with_items-循环>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#创建三个用户</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim useradd.yml</span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: useradd user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>={{</span> item <span style=color:#f92672>}}</span> state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>      with_items:
</span></span><span style=display:flex><span>        - user1
</span></span><span style=display:flex><span>        - user2
</span></span><span style=display:flex><span>        - user3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook useradd.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>useradd user<span style=color:#f92672>]</span> ************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>user1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>user1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>user2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>user2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>user3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>user3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;getent passwd |grep user&#39;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>user1:x:1001:1001::/home/user1:/bin/bash
</span></span><span style=display:flex><span>user2:x:1002:1002::/home/user2:/bin/bash
</span></span><span style=display:flex><span>user3:x:1003:1003::/home/user3:/bin/bash
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>rpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologin
</span></span><span style=display:flex><span>user1:x:54323:54332::/home/user1:/bin/bash
</span></span><span style=display:flex><span>user2:x:54324:54333::/home/user2:/bin/bash
</span></span><span style=display:flex><span>user3:x:54325:54334::/home/user3:/bin/bash
</span></span></code></pre></div><p>当每个条目都是由多个键值对组成的时候</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim add.yml </span>
</span></span><span style=display:flex><span>- hosts: db
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: create group
</span></span><span style=display:flex><span>      group: name<span style=color:#f92672>={{</span> item <span style=color:#f92672>}}</span> state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>      with_items:
</span></span><span style=display:flex><span>        - group1
</span></span><span style=display:flex><span>        - group2
</span></span><span style=display:flex><span>        - group3
</span></span><span style=display:flex><span>    - name: create user
</span></span><span style=display:flex><span>      user: name<span style=color:#f92672>={{</span> item.name <span style=color:#f92672>}}</span> group<span style=color:#f92672>={{</span> item.group <span style=color:#f92672>}}</span> state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>      with_items:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> name: <span style=color:#e6db74>&#39;user1&#39;</span>, group: <span style=color:#e6db74>&#39;group1&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> name: <span style=color:#e6db74>&#39;user2&#39;</span>, group: <span style=color:#e6db74>&#39;group2&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> name: <span style=color:#e6db74>&#39;user3&#39;</span>, group: <span style=color:#e6db74>&#39;group3&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook add.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>db<span style=color:#f92672>]</span> **********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create group<span style=color:#f92672>]</span> ************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>group1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>group1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>group2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>group2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>group3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>group3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>create user<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;group&#39;</span>: u<span style=color:#e6db74>&#39;group1&#39;</span>, u<span style=color:#e6db74>&#39;name&#39;</span>: u<span style=color:#e6db74>&#39;user1&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;group&#39;</span>: u<span style=color:#e6db74>&#39;group1&#39;</span>, u<span style=color:#e6db74>&#39;name&#39;</span>: u<span style=color:#e6db74>&#39;user1&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;group&#39;</span>: u<span style=color:#e6db74>&#39;group2&#39;</span>, u<span style=color:#e6db74>&#39;name&#39;</span>: u<span style=color:#e6db74>&#39;user2&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;group&#39;</span>: u<span style=color:#e6db74>&#39;group2&#39;</span>, u<span style=color:#e6db74>&#39;name&#39;</span>: u<span style=color:#e6db74>&#39;user2&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;group&#39;</span>: u<span style=color:#e6db74>&#39;group3&#39;</span>, u<span style=color:#e6db74>&#39;name&#39;</span>: u<span style=color:#e6db74>&#39;user3&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;group&#39;</span>: u<span style=color:#e6db74>&#39;group3&#39;</span>, u<span style=color:#e6db74>&#39;name&#39;</span>: u<span style=color:#e6db74>&#39;user3&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;getent passwd |grep user&#39;</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>user1:x:1001:1001::/home/user1:/bin/bash
</span></span><span style=display:flex><span>user2:x:1002:1002::/home/user2:/bin/bash
</span></span><span style=display:flex><span>user3:x:1003:1003::/home/user3:/bin/bash
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>rpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologin
</span></span><span style=display:flex><span>user1:x:54323:54332::/home/user1:/bin/bash
</span></span><span style=display:flex><span>user2:x:54324:54333::/home/user2:/bin/bash
</span></span><span style=display:flex><span>user3:x:54325:54334::/home/user3:/bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible db -m shell -a &#39;getent group |grep group&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>group1:x:54332:
</span></span><span style=display:flex><span>group2:x:54333:
</span></span><span style=display:flex><span>group3:x:54334:
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>group1:x:1001:
</span></span><span style=display:flex><span>group2:x:1002:
</span></span><span style=display:flex><span>group3:x:1003:
</span></span></code></pre></div><h5 id=流程控制>流程控制<a hidden class=anchor aria-hidden=true href=#流程控制>#</a></h5><p><strong>if</strong></p><p>基于nginx.conf创建一个新的配置文件，用 if 实现到每台远程主机的配置文件都不同</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#修改主机清单</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim/etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48 nginx_port<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> nginx_vhost<span style=color:#f92672>=</span>manager.test.com
</span></span><span style=display:flex><span>192.168.31.23 nginx_port<span style=color:#f92672>=</span><span style=color:#ae81ff>97</span>
</span></span><span style=display:flex><span>192.168.31.33 nginx_vhost<span style=color:#f92672>=</span>node02.test.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改模板文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim templates/nginx.conf.j2</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>% <span style=color:#66d9ef>if</span> nginx_port is defined %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  listen <span style=color:#f92672>{{</span> nginx_port <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>% endif %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>%if nginx_vhost is defined %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  server_name <span style=color:#f92672>{{</span> nginx_vhost <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>% endif %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#编写playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim if.yml </span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: nginx vhost
</span></span><span style=display:flex><span>      template: src<span style=color:#f92672>=</span>./templates/nginx.conf.j2 dest<span style=color:#f92672>=</span>/tmp/vhost.conf
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook if.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>nginx vhost<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -a &#39;cat /tmp/vhost.conf&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    server_name node02.test.com
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    listen <span style=color:#ae81ff>97</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    listen <span style=color:#ae81ff>96</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    server_name manager.test.com
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>for</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 templates<span style=color:#f92672>]</span><span style=color:#75715e># vim /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48
</span></span><span style=display:flex><span>192.168.31.23
</span></span><span style=display:flex><span>192.168.31.33
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 templates<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx.conf.j2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>% <span style=color:#66d9ef>for</span> nginx_port in ports %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#f92672>{{</span> nginx_port <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>% endfor %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># vim for.yml </span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: False
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>101</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>102</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: test <span style=color:#66d9ef>for</span>
</span></span><span style=display:flex><span>      template: src<span style=color:#f92672>=</span>./templates/nginx.conf.j2 dest<span style=color:#f92672>=</span>/tmp/for.conf 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook for.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>test <span style=color:#66d9ef>for</span><span style=color:#f92672>]</span> ****************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 playbook<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -a &#39;cat /tmp/for.conf&#39; -l 192.168.31.23</span>
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>101</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>102</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=roles>roles<a hidden class=anchor aria-hidden=true href=#roles>#</a></h4><p><code>ansible</code>自<code>1.2</code>版本引入的新特性，用于层次性、结构化地组织<code>playbook</code>。<code>roles</code>能够根据层次型结构自动装载变量文件、<code>tasks</code>以及<code>handlers</code>等。要使用<code>roles</code>只需要在<code>playbook</code>中使用<code>include</code>指令引入即可。简单来讲，<code>roles</code>就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的<code>include</code>它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。</p><p><strong>roles目录结构</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>roles/
</span></span><span style=display:flex><span>    common/               <span style=color:#75715e># this hierarchy represents a &#34;role&#34;</span>
</span></span><span style=display:flex><span>        tasks/            <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>            main.yml      <span style=color:#75715e>#  &lt;-- tasks file can include smaller files if warranted</span>
</span></span><span style=display:flex><span>        handlers/         <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>            main.yml      <span style=color:#75715e>#  &lt;-- handlers file</span>
</span></span><span style=display:flex><span>        templates/        <span style=color:#75715e>#  &lt;-- files for use with the template resource</span>
</span></span><span style=display:flex><span>            ntp.conf.j2   <span style=color:#75715e>#  &lt;------- templates end in .j2</span>
</span></span><span style=display:flex><span>        files/            <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>            bar.txt       <span style=color:#75715e>#  &lt;-- files for use with the copy resource</span>
</span></span><span style=display:flex><span>            foo.sh        <span style=color:#75715e>#  &lt;-- script files for use with the script resource</span>
</span></span><span style=display:flex><span>        vars/             <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>            main.yml      <span style=color:#75715e>#  &lt;-- variables associated with this role</span>
</span></span><span style=display:flex><span>        defaults/         <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>            main.yml      <span style=color:#75715e>#  &lt;-- default lower priority variables for this role</span>
</span></span><span style=display:flex><span>        meta/             <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>            main.yml      <span style=color:#75715e>#  &lt;-- role dependencies</span>
</span></span><span style=display:flex><span>        library/          <span style=color:#75715e># roles can also include custom modules</span>
</span></span><span style=display:flex><span>        module_utils/     <span style=color:#75715e># roles can also include custom module_utils</span>
</span></span><span style=display:flex><span>        lookup_plugins/   <span style=color:#75715e># or other types of plugins, like lookup in this case</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    webtier/              <span style=color:#75715e># same kind of structure as &#34;common&#34; was above, done for the webtier role</span>
</span></span><span style=display:flex><span>    monitoring/           <span style=color:#75715e># &#34;&#34;</span>
</span></span><span style=display:flex><span>    fooapp/               <span style=color:#75715e># &#34;&#34;</span>
</span></span></code></pre></div><p><strong>通过roles的方式安装nginx</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># pwd</span>
</span></span><span style=display:flex><span>/etc/ansible/roles
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># mkdir -p nginx/{tasks,vars,templates,handlers}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#主机清单</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>web<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.31.48
</span></span><span style=display:flex><span>192.168.31.23
</span></span><span style=display:flex><span>192.168.31.33
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#jinja2模板文件，修改以下两个参数</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx/templates/nginx.conf.j2</span>
</span></span><span style=display:flex><span>user www;
</span></span><span style=display:flex><span>listen       <span style=color:#f92672>{{</span> nginx_port <span style=color:#f92672>}}</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#工作任务文件，也可以把每个task单独写成一个yml文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx/tasks/main.yml </span>
</span></span><span style=display:flex><span>- name: create user
</span></span><span style=display:flex><span>  user: name<span style=color:#f92672>=</span>www uid<span style=color:#f92672>=</span><span style=color:#ae81ff>666</span> system<span style=color:#f92672>=</span>yes shell<span style=color:#f92672>=</span>/sbin/nologin
</span></span><span style=display:flex><span>- name: install nginx
</span></span><span style=display:flex><span>  yum: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>present
</span></span><span style=display:flex><span>- name: install config
</span></span><span style=display:flex><span>  template: src<span style=color:#f92672>=</span>nginx.conf.j2 dest<span style=color:#f92672>=</span>/etc/nginx/nginx.conf
</span></span><span style=display:flex><span>  notify: restart nginx
</span></span><span style=display:flex><span>- name: start nginx
</span></span><span style=display:flex><span>  service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>started enabled<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#变量文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx/vars/main.yml </span>
</span></span><span style=display:flex><span>nginx_port: <span style=color:#ae81ff>90</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#触发器文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx/handlers/main.yml </span>
</span></span><span style=display:flex><span>- name: restart nginx
</span></span><span style=display:flex><span>  service: name<span style=color:#f92672>=</span>nginx state<span style=color:#f92672>=</span>restarted
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>#编写nginx_role.yml调用nginx角色</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx_role.yml </span>
</span></span><span style=display:flex><span>- hosts: web
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  roles:
</span></span><span style=display:flex><span>    - role: nginx
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>#目录结构</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># tree</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── nginx
</span></span><span style=display:flex><span>│   ├── handlers
</span></span><span style=display:flex><span>│   │   └── main.yml
</span></span><span style=display:flex><span>│   ├── tasks
</span></span><span style=display:flex><span>│   │   └── main.yml
</span></span><span style=display:flex><span>│   ├── templates
</span></span><span style=display:flex><span>│   │   └── nginx.conf.j2
</span></span><span style=display:flex><span>│   └── vars
</span></span><span style=display:flex><span>│       └── main.yml
</span></span><span style=display:flex><span>└── nginx_role.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#执行playbook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook nginx_role.yml</span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>web<span style=color:#f92672>]</span> *********************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>nginx : create user<span style=color:#f92672>]</span> *****************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>install nginx<span style=color:#f92672>]</span> ***********************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>nginx : install config<span style=color:#f92672>]</span> **************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>start nginx<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>restart nginx<span style=color:#f92672>]</span> ************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.23<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.33<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>192.168.31.48<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.31.23              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.33              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>192.168.31.48              : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@manager01 roles<span style=color:#f92672>]</span><span style=color:#75715e># ansible web -m shell -a &#39;netstat -tnulp |grep nginx&#39;</span>
</span></span><span style=display:flex><span>192.168.31.33 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:90              0.0.0.0:*               LISTEN      34692/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::90                   :::*                    LISTEN      34692/nginx: master 
</span></span><span style=display:flex><span>192.168.31.23 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:90              0.0.0.0:*               LISTEN      16162/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::90                   :::*                    LISTEN      16162/nginx: master 
</span></span><span style=display:flex><span>192.168.31.48 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:90              0.0.0.0:*               LISTEN      58709/nginx: master 
</span></span><span style=display:flex><span>tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::90                   :::*                    LISTEN      58709/nginx: master
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://jiayi26.github.io/tags/ansible/>Ansible</a></li></ul><nav class=paginav><a class=prev href=https://jiayi26.github.io/posts/tcp%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/><span class=title>« Prev Page</span><br><span>TCP三次握手和四次挥手</span></a>
<a class=next href=https://jiayi26.github.io/posts/kubernetes/><span class=title>Next Page »</span><br><span></span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Ansible on twitter" href="https://twitter.com/intent/tweet/?text=Ansible&url=https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f&hashtags=Ansible"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Ansible on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f&title=Ansible&summary=Ansible&source=https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Ansible on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f&title=Ansible"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Ansible on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Ansible on whatsapp" href="https://api.whatsapp.com/send?text=Ansible%20-%20https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Ansible on telegram" href="https://telegram.me/share/url?text=Ansible&url=https%3a%2f%2fjiayi26.github.io%2fposts%2fansible%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://jiayi26.github.io/>JIAYI's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>