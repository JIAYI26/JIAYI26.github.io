<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>变量、流程控制与游标 | JIAYI's Blog</title><meta name=keywords content="MySQL"><meta name=description content="第16章_变量、流程控制与游标 1. 变量 在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。
在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。
1.1 系统变量 1.1.1 系统变量分类 变量由系统定义，不是用户定义，属于服务器层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是编译MySQL时参数的默认值，要么是配置文件（例如my.ini等）中的参数值。大家可以通过网址 https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html 查看MySQL文档的系统变量。
系统变量分为全局系统变量（需要添加global 关键字）以及会话系统变量（需要添加 session 关键字），有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。**如果不写，默认会话级别。**静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。
每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：
 全局系统变量针对于所有会话（连接）有效，但不能跨重启 会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。 会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。  在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。
1.1.2 查看系统变量  查看所有或部分系统变量  #查看所有全局变量 SHOW GLOBAL VARIABLES;  #查看所有会话变量 SHOW SESSION VARIABLES; 或 SHOW VARIABLES; #查看满足条件的部分系统变量。 SHOW GLOBAL VARIABLES LIKE '%标识符%';  #查看满足条件的部分会话变量 SHOW SESSION VARIABLES LIKE '%标识符%'; 举例：
SHOW GLOBAL VARIABLES LIKE 'admin_%';  查看指定系统变量  作为 MySQL 编码规范，MySQL 中的系统变量以两个“@”开头，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。"><meta name=author content="Me"><link rel=canonical href=https://jiayi26.github.io/posts/%E7%AC%AC16%E7%AB%A0_%E5%8F%98%E9%87%8F%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%B8%B8%E6%A0%87/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=icon type=image/png sizes=16x16 href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=icon type=image/png sizes=32x32 href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=apple-touch-icon href=https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3><link rel=mask-icon href=https://jiayi26.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="变量、流程控制与游标"><meta property="og:description" content="第16章_变量、流程控制与游标 1. 变量 在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。
在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。
1.1 系统变量 1.1.1 系统变量分类 变量由系统定义，不是用户定义，属于服务器层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是编译MySQL时参数的默认值，要么是配置文件（例如my.ini等）中的参数值。大家可以通过网址 https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html 查看MySQL文档的系统变量。
系统变量分为全局系统变量（需要添加global 关键字）以及会话系统变量（需要添加 session 关键字），有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。**如果不写，默认会话级别。**静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。
每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：
 全局系统变量针对于所有会话（连接）有效，但不能跨重启 会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。 会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。  在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。
1.1.2 查看系统变量  查看所有或部分系统变量  #查看所有全局变量 SHOW GLOBAL VARIABLES;  #查看所有会话变量 SHOW SESSION VARIABLES; 或 SHOW VARIABLES; #查看满足条件的部分系统变量。 SHOW GLOBAL VARIABLES LIKE '%标识符%';  #查看满足条件的部分会话变量 SHOW SESSION VARIABLES LIKE '%标识符%'; 举例：
SHOW GLOBAL VARIABLES LIKE 'admin_%';  查看指定系统变量  作为 MySQL 编码规范，MySQL 中的系统变量以两个“@”开头，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。"><meta property="og:type" content="article"><meta property="og:url" content="https://jiayi26.github.io/posts/%E7%AC%AC16%E7%AB%A0_%E5%8F%98%E9%87%8F%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%B8%B8%E6%A0%87/"><meta property="article:section" content="posts"><meta property="og:site_name" content="JIAYI's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="变量、流程控制与游标"><meta name=twitter:description content="第16章_变量、流程控制与游标 1. 变量 在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。
在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。
1.1 系统变量 1.1.1 系统变量分类 变量由系统定义，不是用户定义，属于服务器层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是编译MySQL时参数的默认值，要么是配置文件（例如my.ini等）中的参数值。大家可以通过网址 https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html 查看MySQL文档的系统变量。
系统变量分为全局系统变量（需要添加global 关键字）以及会话系统变量（需要添加 session 关键字），有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。**如果不写，默认会话级别。**静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。
每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：
 全局系统变量针对于所有会话（连接）有效，但不能跨重启 会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。 会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。  在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。
1.1.2 查看系统变量  查看所有或部分系统变量  #查看所有全局变量 SHOW GLOBAL VARIABLES;  #查看所有会话变量 SHOW SESSION VARIABLES; 或 SHOW VARIABLES; #查看满足条件的部分系统变量。 SHOW GLOBAL VARIABLES LIKE '%标识符%';  #查看满足条件的部分会话变量 SHOW SESSION VARIABLES LIKE '%标识符%'; 举例：
SHOW GLOBAL VARIABLES LIKE 'admin_%';  查看指定系统变量  作为 MySQL 编码规范，MySQL 中的系统变量以两个“@”开头，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jiayi26.github.io/posts/"},{"@type":"ListItem","position":2,"name":"变量、流程控制与游标","item":"https://jiayi26.github.io/posts/%E7%AC%AC16%E7%AB%A0_%E5%8F%98%E9%87%8F%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%B8%B8%E6%A0%87/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"变量、流程控制与游标","name":"变量、流程控制与游标","description":"第16章_变量、流程控制与游标 1. 变量 在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。\n在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。\n1.1 系统变量 1.1.1 系统变量分类 变量由系统定义，不是用户定义，属于服务器层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是编译MySQL时参数的默认值，要么是配置文件（例如my.ini等）中的参数值。大家可以通过网址 https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html 查看MySQL文档的系统变量。\n系统变量分为全局系统变量（需要添加global 关键字）以及会话系统变量（需要添加 session 关键字），有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。**如果不写，默认会话级别。**静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。\n每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：\n 全局系统变量针对于所有会话（连接）有效，但不能跨重启 会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。 会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。  在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。\n1.1.2 查看系统变量  查看所有或部分系统变量  #查看所有全局变量 SHOW GLOBAL VARIABLES;  #查看所有会话变量 SHOW SESSION VARIABLES; 或 SHOW VARIABLES; #查看满足条件的部分系统变量。 SHOW GLOBAL VARIABLES LIKE \u0026#39;%标识符%\u0026#39;;  #查看满足条件的部分会话变量 SHOW SESSION VARIABLES LIKE \u0026#39;%标识符%\u0026#39;; 举例：\nSHOW GLOBAL VARIABLES LIKE \u0026#39;admin_%\u0026#39;;  查看指定系统变量  作为 MySQL 编码规范，MySQL 中的系统变量以两个“@”开头，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。","keywords":["MySQL"],"articleBody":"第16章_变量、流程控制与游标 1. 变量 在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。\n在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。\n1.1 系统变量 1.1.1 系统变量分类 变量由系统定义，不是用户定义，属于服务器层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是编译MySQL时参数的默认值，要么是配置文件（例如my.ini等）中的参数值。大家可以通过网址 https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html 查看MySQL文档的系统变量。\n系统变量分为全局系统变量（需要添加global 关键字）以及会话系统变量（需要添加 session 关键字），有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。**如果不写，默认会话级别。**静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。\n每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：\n 全局系统变量针对于所有会话（连接）有效，但不能跨重启 会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。 会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。  在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。\n1.1.2 查看系统变量  查看所有或部分系统变量  #查看所有全局变量 SHOW GLOBAL VARIABLES;  #查看所有会话变量 SHOW SESSION VARIABLES; 或 SHOW VARIABLES; #查看满足条件的部分系统变量。 SHOW GLOBAL VARIABLES LIKE '%标识符%';  #查看满足条件的部分会话变量 SHOW SESSION VARIABLES LIKE '%标识符%'; 举例：\nSHOW GLOBAL VARIABLES LIKE 'admin_%';  查看指定系统变量  作为 MySQL 编码规范，MySQL 中的系统变量以两个“@”开头，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。\n#查看指定的系统变量的值 SELECT @@global.变量名;  #查看指定的会话变量的值 SELECT @@session.变量名; #或者 SELECT @@变量名;  修改系统变量的值  有些时候，数据库管理员需要修改系统变量的默认值，以便修改当前会话或者MySQL服务实例的属性、特征。具体方法：\n方式1：修改MySQL配置文件，继而修改MySQL系统变量的值（该方法需要重启MySQL服务）\n方式2：在MySQL服务运行期间，使用“set”命令重新设置系统变量的值\n#为某个系统变量赋值 #方式1： SET @@global.变量名=变量值; #方式2： SET GLOBAL 变量名=变量值;   #为某个会话变量赋值 #方式1： SET @@session.变量名=变量值; #方式2： SET SESSION 变量名=变量值; 举例：\nSELECT @@global.autocommit; SET GLOBAL autocommit=0; SELECT @@session.tx_isolation; SET @@session.tx_isolation='read-uncommitted'; SET GLOBAL max_connections = 1000; SELECT @@global.max_connections; 1.2 用户变量 1.2.1 用户变量分类 用户变量是用户自己定义的，作为 MySQL 编码规范，MySQL 中的用户变量以一个“@”开头。根据作用范围不同，又分为会话用户变量和局部变量。\n  会话用户变量：作用域和会话变量一样，只对当前连接会话有效。\n  局部变量：只在 BEGIN 和 END 语句块中有效。局部变量只能在存储过程和函数中使用。\n  1.2.2 会话用户变量  变量的定义  #方式1：“=”或“:=” SET @用户变量 = 值; SET @用户变量 := 值;  #方式2：“:=” 或 INTO关键字 SELECT @用户变量 := 表达式 [FROM 等子句]; SELECT 表达式 INTO @用户变量 [FROM 等子句];  查看用户变量的值 （查看、比较、运算等）  SELECT @用户变量  举例  SET @a = 1;  SELECT @a; SELECT @num := COUNT(*) FROM employees;  SELECT @num; SELECT AVG(salary) INTO @avgsalary FROM employees;  SELECT @avgsalary; SELECT @big; #查看某个未声明的变量时，将得到NULL值 1.2.3 局部变量 定义：可以使用DECLARE语句定义一个局部变量\n作用域：仅仅在定义它的 BEGIN … END 中有效\n位置：只能放在 BEGIN … END 中，而且只能放在第一句\nBEGIN \t#声明局部变量 \tDECLARE 变量名1 变量数据类型 [DEFAULT 变量默认值]; \tDECLARE 变量名2,变量名3,... 变量数据类型 [DEFAULT 变量默认值];  \t#为局部变量赋值 \tSET 变量名1 = 值; \tSELECT 值 INTO 变量名2 [FROM 子句];  \t#查看局部变量的值 \tSELECT 变量1,变量2,变量3; END 1.定义变量\nDECLARE 变量名 类型 [default 值]; # 如果没有DEFAULT子句，初始值为NULL 举例：\nDECLARE　myparam　INT　DEFAULT 100; 2.变量赋值\n方式1：一般用于赋简单的值\nSET 变量名=值; SET 变量名:=值; 方式2：一般用于赋表中的字段值\nSELECT 字段名或表达式 INTO 变量名 FROM 表; 3.使用变量（查看、比较、运算等）\nSELECT 局部变量名; 举例1：声明局部变量，并分别赋值为employees表中employee_id为102的last_name和salary\nDELIMITER //  CREATE PROCEDURE set_value() BEGIN \tDECLARE emp_name VARCHAR(25); \tDECLARE sal DOUBLE(10,2); \t\tSELECT last_name,salary INTO emp_name,sal \tFROM employees \tWHERE employee_id = 102; \t\tSELECT emp_name,sal; END //  DELIMITER ; 举例2：声明两个变量，求和并打印 （分别使用会话用户变量、局部变量的方式实现）\n#方式1：使用用户变量 SET @m=1; SET @n=1; SET @sum=@m+@n;  SELECT @sum; #方式2：使用局部变量 DELIMITER //  CREATE PROCEDURE add_value() BEGIN \t#局部变量 \tDECLARE m INT DEFAULT 1; \tDECLARE n INT DEFAULT 3; \tDECLARE SUM INT; \t\tSET SUM = m+n; \tSELECT SUM; END //  DELIMITER ; 举例3：创建存储过程“different_salary”查询某员工和他领导的薪资差距，并用IN参数emp_id接收员工id，用OUT参数dif_salary输出薪资差距结果。\n#声明 DELIMITER //  CREATE PROCEDURE different_salary(IN emp_id INT,OUT dif_salary DOUBLE) BEGIN \t#声明局部变量 \tDECLARE emp_sal,mgr_sal DOUBLE DEFAULT 0.0; \tDECLARE mgr_id INT; \t\tSELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id; \tSELECT manager_id INTO mgr_id FROM employees WHERE employee_id = emp_id; \tSELECT salary INTO mgr_sal FROM employees WHERE employee_id = mgr_id; \tSET dif_salary = mgr_sal - emp_sal;  END //  DELIMITER ;  #调用 SET @emp_id = 102; CALL different_salary(@emp_id,@diff_sal);   #查看 SELECT @diff_sal; 1.2.4 对比会话用户变量与局部变量 \t作用域\t定义位置\t语法 会话用户变量\t当前会话\t会话的任何地方\t加@符号，不用指定类型 局部变量\t定义它的BEGIN END中 BEGIN END的第一句话\t一般不用加@,需要指定类型 2. 定义条件与处理程序 定义条件是事先定义程序执行过程中可能遇到的问题，处理程序定义了在遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。这样可以增强存储程序处理问题的能力，避免程序异常停止运行。\n说明：定义条件和处理程序在存储过程、存储函数中都是支持的。\n2.1 案例分析 **案例分析：**创建一个名称为“UpdateDataNoCondition”的存储过程。代码如下：\nDELIMITER //  CREATE PROCEDURE UpdateDataNoCondition() \tBEGIN \tSET @x = 1; \tUPDATE employees SET email = NULL WHERE last_name = 'Abel'; \tSET @x = 2; \tUPDATE employees SET email = 'aabbel' WHERE last_name = 'Abel'; \tSET @x = 3; \tEND //  DELIMITER ; 调用存储过程：\nmysql CALL UpdateDataNoCondition(); ERROR 1048 (23000): Column 'email' cannot be null  mysql SELECT @x; +------+ | @x | +------+ | 1 | +------+ 1 row in set (0.00 sec) 可以看到，此时@x变量的值为1。结合创建存储过程的SQL语句代码可以得出：在存储过程中未定义条件和处理程序，且当存储过程中执行的SQL语句报错时，MySQL数据库会抛出错误，并退出当前SQL逻辑，不再向下继续执行。\n2.2 定义条件 定义条件就是给MySQL中的错误码命名，这有助于存储的程序代码更清晰。它将一个错误名字和指定的错误条件关联起来。这个名字可以随后被用在定义处理程序的DECLARE HANDLER语句中。\n定义条件使用DECLARE语句，语法格式如下：\nDECLARE 错误名称 CONDITION FOR 错误码（或错误条件） 错误码的说明：\n MySQL_error_code和sqlstate_value都可以表示MySQL的错误。  MySQL_error_code是数值类型错误代码。 sqlstate_value是长度为5的字符串类型错误代码。   例如，在ERROR 1418 (HY000)中，1418是MySQL_error_code，‘HY000’是sqlstate_value。 例如，在ERROR 1142（42000）中，1142是MySQL_error_code，‘42000’是sqlstate_value。  **举例1：**定义“Field_Not_Be_NULL”错误名与MySQL中违反非空约束的错误类型是“ERROR 1048 (23000)”对应。\n#使用MySQL_error_code DECLARE Field_Not_Be_NULL CONDITION FOR 1048;  #使用sqlstate_value DECLARE Field_Not_Be_NULL CONDITION FOR SQLSTATE '23000'; **举例2：**定义\"ERROR 1148(42000)“错误，名称为command_not_allowed。\n#使用MySQL_error_code DECLARE command_not_allowed CONDITION FOR 1148;  #使用sqlstate_value DECLARE command_not_allowed CONDITION FOR SQLSTATE '42000'; 2.3 定义处理程序 可以为SQL执行过程中发生的某种类型的错误定义特殊的处理程序。定义处理程序时，使用DECLARE语句的语法如下：\nDECLARE 处理方式 HANDLER FOR 错误类型 处理语句  处理方式：处理方式有3个取值：CONTINUE、EXIT、UNDO。  CONTINUE：表示遇到错误不处理，继续执行。 EXIT：表示遇到错误马上退出。 UNDO：表示遇到错误后撤回之前的操作。MySQL中暂时不支持这样的操作。   错误类型（即条件）可以有如下取值：  SQLSTATE '字符串错误码'：表示长度为5的sqlstate_value类型的错误代码； MySQL_error_code：匹配数值类型错误代码； 错误名称：表示DECLARE … CONDITION定义的错误条件名称。 SQLWARNING：匹配所有以01开头的SQLSTATE错误代码； NOT FOUND：匹配所有以02开头的SQLSTATE错误代码； SQLEXCEPTION：匹配所有没有被SQLWARNING或NOT FOUND捕获的SQLSTATE错误代码；   处理语句：如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像“SET 变量 = 值”这样的简单语句，也可以是使用BEGIN ... END编写的复合语句。  定义处理程序的几种方式，代码如下：\n#方法1：捕获sqlstate_value DECLARE CONTINUE HANDLER FOR SQLSTATE '42S02' SET @info = 'NO_SUCH_TABLE';  #方法2：捕获mysql_error_value DECLARE CONTINUE HANDLER FOR 1146 SET @info = 'NO_SUCH_TABLE';  #方法3：先定义条件，再调用 DECLARE no_such_table CONDITION FOR 1146; DECLARE CONTINUE HANDLER FOR NO_SUCH_TABLE SET @info = 'NO_SUCH_TABLE';  #方法4：使用SQLWARNING DECLARE EXIT HANDLER FOR SQLWARNING SET @info = 'ERROR';  #方法5：使用NOT FOUND DECLARE EXIT HANDLER FOR NOT FOUND SET @info = 'NO_SUCH_TABLE';  #方法6：使用SQLEXCEPTION DECLARE EXIT HANDLER FOR SQLEXCEPTION SET @info = 'ERROR'; 2.4 案例解决 在存储过程中，定义处理程序，捕获sqlstate_value值，当遇到MySQL_error_code值为1048时，执行CONTINUE操作，并且将@proc_value的值设置为-1。\nDELIMITER //  CREATE PROCEDURE UpdateDataNoCondition() \tBEGIN \t#定义处理程序 \tDECLARE CONTINUE HANDLER FOR 1048 SET @proc_value = -1; \t\tSET @x = 1; \tUPDATE employees SET email = NULL WHERE last_name = 'Abel'; \tSET @x = 2; \tUPDATE employees SET email = 'aabbel' WHERE last_name = 'Abel'; \tSET @x = 3; \tEND //  DELIMITER ; 调用过程：\nmysql CALL UpdateDataWithCondition(); Query OK, 0 rows affected (0.01 sec)  mysql SELECT @x,@proc_value; +------+-------------+ | @x | @proc_value | +------+-------------+ | 3 | -1 | +------+-------------+ 1 row in set (0.00 sec) 举例：\n创建一个名称为“InsertDataWithCondition”的存储过程，代码如下。\n在存储过程中，定义处理程序，捕获sqlstate_value值，当遇到sqlstate_value值为23000时，执行EXIT操作，并且将@proc_value的值设置为-1。\n#准备工作 CREATE TABLE departments AS SELECT * FROM atguigudb.`departments`;  ALTER TABLE departments ADD CONSTRAINT uk_dept_name UNIQUE(department_id); DELIMITER //  CREATE PROCEDURE InsertDataWithCondition() \tBEGIN \tDECLARE duplicate_entry CONDITION FOR SQLSTATE '23000' ; \tDECLARE EXIT HANDLER FOR duplicate_entry SET @proc_value = -1; \t\tSET @x = 1; \tINSERT INTO departments(department_name) VALUES('测试'); \tSET @x = 2; \tINSERT INTO departments(department_name) VALUES('测试'); \tSET @x = 3; \tEND //  DELIMITER ; 调用存储过程：\nmysql CALL InsertDataWithCondition(); Query OK, 0 rows affected (0.01 sec)  mysql SELECT @x,@proc_value; +------+-------------+ | @x | @proc_value | +------+-------------+ | 2 | -1 | +------+-------------+ 1 row in set (0.00 sec) 3. 流程控制 解决复杂问题不可能通过一个 SQL 语句完成，我们需要执行多个 SQL 操作。流程控制语句的作用就是控制存储过程中 SQL 语句的执行顺序，是我们完成复杂操作必不可少的一部分。只要是执行的程序，流程就分为三大类：\n 顺序结构：程序从上往下依次执行 分支结构：程序按条件进行选择执行，从两条或多条路径中选择一条执行 循环结构：程序满足一定条件下，重复执行一组语句  针对于MySQL 的流程控制语句主要有 3 类。注意：只能用于存储程序。\n 条件判断语句：IF 语句和 CASE 语句 循环语句：LOOP、WHILE 和 REPEAT 语句 跳转语句：ITERATE 和 LEAVE 语句  3.1 分支结构之 IF  IF 语句的语法结构是：  IF 表达式1 THEN 操作1 [ELSEIF 表达式2 THEN 操作2]…… [ELSE 操作N] END IF 根据表达式的结果为TRUE或FALSE执行相应的语句。这里“[]”中的内容是可选的。\n  特点：① 不同的表达式对应不同的操作 ② 使用在begin end中\n  举例1：\nIF val IS NULL \tTHEN SELECT 'val is null'; ELSE SELECT 'val is not null';  END IF;   **举例2：**声明存储过程“update_salary_by_eid1”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于8000元并且入职时间超过5年，就涨薪500元；否则就不变。\nDELIMITER //  CREATE PROCEDURE update_salary_by_eid1(IN emp_id INT) BEGIN \tDECLARE emp_salary DOUBLE; \tDECLARE hire_year DOUBLE;  \tSELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;  \tSELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year \tFROM employees WHERE employee_id = emp_id;  \tIF emp_salary  8000 AND hire_year  5 \tTHEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id; \tEND IF; END //   DELIMITER ;   **举例3：**声明存储过程“update_salary_by_eid2”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元并且入职时间超过5年，就涨薪500元；否则就涨薪100元。\nDELIMITER //  CREATE PROCEDURE update_salary_by_eid2(IN emp_id INT) BEGIN \tDECLARE emp_salary DOUBLE; \tDECLARE hire_year DOUBLE;  \tSELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;  \tSELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year \tFROM employees WHERE employee_id = emp_id;  \tIF emp_salary  8000 AND hire_year  5 \tTHEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id; \tELSE \tUPDATE employees SET salary = salary + 100 WHERE employee_id = emp_id; \tEND IF; END //   DELIMITER ;   **举例4：**声明存储过程“update_salary_by_eid3”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资如果大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元。\nDELIMITER //  CREATE PROCEDURE update_salary_by_eid3(IN emp_id INT) BEGIN \tDECLARE emp_salary DOUBLE; \tDECLARE bonus DECIMAL(3,2);  \tSELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id; \tSELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;  \tIF emp_salary  9000 \tTHEN UPDATE employees SET salary = 9000 WHERE employee_id = emp_id; \tELSEIF emp_salary  10000 AND bonus IS NULL \tTHEN UPDATE employees SET commission_pct = 0.01 WHERE employee_id = emp_id; \tELSE \tUPDATE employees SET salary = salary + 100 WHERE employee_id = emp_id; \tEND IF; END //  DELIMITER ;   3.2 分支结构之 CASE CASE 语句的语法结构1：\n#情况一：类似于switch CASE 表达式 WHEN 值1 THEN 结果1或语句1(如果是语句，需要加分号) WHEN 值2 THEN 结果2或语句2(如果是语句，需要加分号) ... ELSE 结果n或语句n(如果是语句，需要加分号) END [case]（如果是放在begin end中需要加上case，如果放在select后面不需要） CASE 语句的语法结构2：\n#情况二：类似于多重if CASE WHEN 条件1 THEN 结果1或语句1(如果是语句，需要加分号) WHEN 条件2 THEN 结果2或语句2(如果是语句，需要加分号) ... ELSE 结果n或语句n(如果是语句，需要加分号) END [case]（如果是放在begin end中需要加上case，如果放在select后面不需要）  举例1：  使用CASE流程控制语句的第1种格式，判断val值等于1、等于2，或者两者都不等。\nCASE val 　WHEN 1 THEN SELECT 'val is 1'; 　WHEN 2 THEN SELECT 'val is 2'; 　ELSE SELECT 'val is not 1 or 2'; END CASE;  举例2：  使用CASE流程控制语句的第2种格式，判断val是否为空、小于0、大于0或者等于0。\nCASE \tWHEN val IS NULL THEN SELECT 'val is null'; \tWHEN val  0 THEN SELECT 'val is less than 0'; \tWHEN val  0 THEN SELECT 'val is greater than 0'; \tELSE SELECT 'val is 0'; END CASE;  **举例3：**声明存储过程“update_salary_by_eid4”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元。  DELIMITER //  CREATE PROCEDURE update_salary_by_eid4(IN emp_id INT) BEGIN \tDECLARE emp_sal DOUBLE; \tDECLARE bonus DECIMAL(3,2);  \tSELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id; \tSELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;  \tCASE \tWHEN emp_sal9000 \tTHEN UPDATE employees SET salary=9000 WHERE employee_id = emp_id; \tWHEN emp_sal10000 AND bonus IS NULL \tTHEN UPDATE employees SET commission_pct=0.01 WHERE employee_id = emp_id; \tELSE \tUPDATE employees SET salary=salary+100 WHERE employee_id = emp_id; \tEND CASE; END //  DELIMITER ;  举例4：声明存储过程update_salary_by_eid5，定义IN参数emp_id，输入员工编号。判断该员工的入职年限，如果是0年，薪资涨50；如果是1年，薪资涨100；如果是2年，薪资涨200；如果是3年，薪资涨300；如果是4年，薪资涨400；其他的涨薪500。  DELIMITER //  CREATE PROCEDURE update_salary_by_eid5(IN emp_id INT) BEGIN \tDECLARE emp_sal DOUBLE; \tDECLARE hire_year DOUBLE;  \tSELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id; \t\tSELECT ROUND(DATEDIFF(CURDATE(),hire_date)/365) INTO hire_year FROM employees WHERE employee_id = emp_id;  \tCASE hire_year \tWHEN 0 THEN UPDATE employees SET salary=salary+50 WHERE employee_id = emp_id; \tWHEN 1 THEN UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id; \tWHEN 2 THEN UPDATE employees SET salary=salary+200 WHERE employee_id = emp_id; \tWHEN 3 THEN UPDATE employees SET salary=salary+300 WHERE employee_id = emp_id; \tWHEN 4 THEN UPDATE employees SET salary=salary+400 WHERE employee_id = emp_id; \tELSE UPDATE employees SET salary=salary+500 WHERE employee_id = emp_id; \tEND CASE; END //  DELIMITER ; 3.3 循环结构之LOOP LOOP循环语句用来重复执行某些语句。LOOP内的语句一直重复执行直到循环被退出（使用LEAVE子句），跳出循环过程。\nLOOP语句的基本格式如下：\n[loop_label:] LOOP \t循环执行的语句 END LOOP [loop_label] 其中，loop_label表示LOOP语句的标注名称，该参数可以省略。\n举例1：\n使用LOOP语句进行循环操作，id值小于10时将重复执行循环过程。\nDECLARE id INT DEFAULT 0; add_loop:LOOP \tSET id = id +1; \tIF id = 10 THEN LEAVE add_loop; \tEND IF;  END LOOP add_loop; **举例2：**当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程“update_salary_loop()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.1倍。直到全公司的平均薪资达到12000结束。并统计循环次数。\nDELIMITER //  CREATE PROCEDURE update_salary_loop(OUT num INT) BEGIN \tDECLARE avg_salary DOUBLE; \tDECLARE loop_count INT DEFAULT 0; \t\tSELECT AVG(salary) INTO avg_salary FROM employees; \t\tlabel_loop:LOOP \tIF avg_salary = 12000 THEN LEAVE label_loop; \tEND IF; \t\tUPDATE employees SET salary = salary * 1.1; \tSET loop_count = loop_count + 1; \tSELECT AVG(salary) INTO avg_salary FROM employees; \tEND LOOP label_loop; \t\tSET num = loop_count;  END //  DELIMITER ; 3.4 循环结构之WHILE WHILE语句创建一个带条件判断的循环过程。WHILE在执行语句执行时，先对指定的表达式进行判断，如果为真，就执行循环内的语句，否则退出循环。WHILE语句的基本格式如下：\n[while_label:] WHILE 循环条件 DO \t循环体 END WHILE [while_label]; while_label为WHILE语句的标注名称；如果循环条件结果为真，WHILE语句内的语句或语句群被执行，直至循环条件为假，退出循环。\n举例1：\nWHILE语句示例，i值小于10时，将重复执行循环过程，代码如下：\nDELIMITER //  CREATE PROCEDURE test_while() BEGIN\t\tDECLARE i INT DEFAULT 0; \t\tWHILE i  10 DO \tSET i = i + 1; \tEND WHILE; \t\tSELECT i; END //  DELIMITER ; #调用 CALL test_while(); **举例2：**市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“update_salary_while()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家降薪，薪资降为原来的90%。直到全公司的平均薪资达到5000结束。并统计循环次数。\nDELIMITER //  CREATE PROCEDURE update_salary_while(OUT num INT) BEGIN \tDECLARE avg_sal DOUBLE ; \tDECLARE while_count INT DEFAULT 0; \t\tSELECT AVG(salary) INTO avg_sal FROM employees; \t\tWHILE avg_sal  5000 DO \tUPDATE employees SET salary = salary * 0.9; \t\tSET while_count = while_count + 1; \t\tSELECT AVG(salary) INTO avg_sal FROM employees; \tEND WHILE; \t\tSET num = while_count;  END //  DELIMITER ; 3.5 循环结构之REPEAT REPEAT语句创建一个带条件判断的循环过程。与WHILE循环不同的是，REPEAT 循环首先会执行一次循环，然后在 UNTIL 中进行表达式的判断，如果满足条件就退出，即 END REPEAT；如果条件不满足，则会就继续执行循环，直到满足退出条件为止。\nREPEAT语句的基本格式如下：\n[repeat_label:] REPEAT 　循环体的语句 UNTIL 结束循环的条件表达式 END REPEAT [repeat_label] repeat_label为REPEAT语句的标注名称，该参数可以省略；REPEAT语句内的语句或语句群被重复，直至expr_condition为真。\n举例1：\nDELIMITER //  CREATE PROCEDURE test_repeat() BEGIN\t\tDECLARE i INT DEFAULT 0; \t\tREPEAT \tSET i = i + 1; \tUNTIL i = 10 \tEND REPEAT; \t\tSELECT i; END //  DELIMITER ; **举例2：**当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程“update_salary_repeat()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.15倍。直到全公司的平均薪资达到13000结束。并统计循环次数。\nDELIMITER //  CREATE PROCEDURE update_salary_repeat(OUT num INT) BEGIN \tDECLARE avg_sal DOUBLE ; \tDECLARE repeat_count INT DEFAULT 0; \t\tSELECT AVG(salary) INTO avg_sal FROM employees; \t\tREPEAT \tUPDATE employees SET salary = salary * 1.15; \t\tSET repeat_count = repeat_count + 1; \t\tSELECT AVG(salary) INTO avg_sal FROM employees; \tUNTIL avg_sal = 13000 \tEND REPEAT; \t\tSET num = repeat_count; \tEND //  DELIMITER ; 对比三种循环结构：\n1、这三种循环都可以省略名称，但如果循环中添加了循环控制语句（LEAVE或ITERATE）则必须添加名称。 2、 LOOP：一般用于实现简单的\"死\"循环 WHILE：先判断后执行 REPEAT：先执行后判断，无条件至少执行一次\n3.6 跳转语句之LEAVE语句 LEAVE语句：可以用在循环语句内，或者以 BEGIN 和 END 包裹起来的程序体内，表示跳出循环或者跳出程序体的操作。如果你有面向过程的编程语言的使用经验，你可以把 LEAVE 理解为 break。\n基本格式如下：\nLEAVE 标记名 其中，label参数表示循环的标志。LEAVE和BEGIN … END或循环一起被使用。\n**举例1：**创建存储过程 “leave_begin()”，声明INT类型的IN参数num。给BEGIN…END加标记名，并在BEGIN…END中使用IF语句判断num参数的值。\n 如果num 如果num=1，则查询“employees”表的平均薪资； 如果num=2，则查询“employees”表的最低薪资； 如果num2，则查询“employees”表的最高薪资。  IF语句结束后查询“employees”表的总人数。\nDELIMITER //  CREATE PROCEDURE leave_begin(IN num INT)  \tbegin_label: BEGIN \tIF num0 \tTHEN LEAVE begin_label; \tELSEIF num=1 \tTHEN SELECT AVG(salary) FROM employees; \tELSEIF num=2 \tTHEN SELECT MIN(salary) FROM employees; \tELSE \tSELECT MAX(salary) FROM employees; \tEND IF; \t\tSELECT COUNT(*) FROM employees; \tEND //   DELIMITER ; 举例2：\n当市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“leave_while()”，声明OUT参数num，输出循环次数，存储过程中使用WHILE循环给大家降低薪资为原来薪资的90%，直到全公司的平均薪资小于等于10000，并统计循环次数。\nDELIMITER // CREATE PROCEDURE leave_while(OUT num INT)  BEGIN \t# \tDECLARE avg_sal DOUBLE;#记录平均工资 \tDECLARE while_count INT DEFAULT 0; #记录循环次数 \t\tSELECT AVG(salary) INTO avg_sal FROM employees; #① 初始化条件 \t\twhile_label:WHILE TRUE DO #② 循环条件 \t\t#③ 循环体 \tIF avg_sal  10000 THEN \tLEAVE while_label; \tEND IF; \t\tUPDATE employees SET salary = salary * 0.9; \tSET while_count = while_count + 1; \t\t#④ 迭代条件 \tSELECT AVG(salary) INTO avg_sal FROM employees; \t\tEND WHILE; \t\t#赋值 \tSET num = while_count;  END //  DELIMITER ; 3.7 跳转语句之ITERATE语句 ITERATE语句：只能用在循环语句（LOOP、REPEAT和WHILE语句）内，表示重新开始循环，将执行顺序转到语句段开头处。如果你有面向过程的编程语言的使用经验，你可以把 ITERATE 理解为 continue，意思为“再次循环”。\n语句基本格式如下：\nITERATE label label参数表示循环的标志。ITERATE语句必须跟在循环标志前面。\n举例： 定义局部变量num，初始值为0。循环结构中执行num + 1操作。\n 如果num 如果num  15，则退出循环结构；  DELIMITER //  CREATE PROCEDURE test_iterate()  BEGIN \tDECLARE num INT DEFAULT 0; \t\tmy_loop:LOOP \tSET num = num + 1; \t\tIF num  10 \tTHEN ITERATE my_loop; \tELSEIF num  15 \tTHEN LEAVE my_loop; \tEND IF; \t\tSELECT '尚硅谷：让天下没有难学的技术'; \t\tEND LOOP my_loop;  END //  DELIMITER ; 4. 游标 4.1 什么是游标（或光标） 虽然我们也可以通过筛选条件 WHERE 和 HAVING，或者是限定返回记录的关键字 LIMIT 返回一条记录，但是，却无法在结果集中像指针一样，向前定位一条记录、向后定位一条记录，或者是随意定位到某一条记录，并对记录的数据进行处理。\n这个时候，就可以用到游标。游标，提供了一种灵活的操作方式，让我们能够对结果集中的每一条记录进行定位，并对指向的记录中的数据进行操作的数据结构。游标让 SQL 这种面向集合的语言有了面向过程开发的能力。\n在 SQL 中，游标是一种临时的数据库对象，可以指向存储在数据库表中的数据行指针。这里游标充当了指针的作用，我们可以通过操作游标来对数据行进行操作。\nMySQL中游标可以在存储过程和函数中使用。\n比如，我们查询了 employees 数据表中工资高于15000的员工都有哪些：\nSELECT employee_id,last_name,salary FROM employees WHERE salary  15000; 这里我们就可以通过游标来操作数据行，如图所示此时游标所在的行是“108”的记录，我们也可以在结果集上滚动游标，指向结果集中的任意一行。\n4.2 使用游标步骤 游标必须在声明处理程序之前被声明，并且变量和条件还必须在声明游标或处理程序之前被声明。\n如果我们想要使用游标，一般需要经历四个步骤。不同的 DBMS 中，使用游标的语法可能略有不同。\n第一步，声明游标\n在MySQL中，使用DECLARE关键字来声明游标，其语法的基本形式如下：\nDECLARE cursor_name CURSOR FOR select_statement; 这个语法适用于 MySQL，SQL Server，DB2 和 MariaDB。如果是用 Oracle 或者 PostgreSQL，需要写成：\nDECLARE cursor_name CURSOR IS select_statement; 要使用 SELECT 语句来获取数据结果集，而此时还没有开始遍历数据，这里 select_statement 代表的是 SELECT 语句，返回一个用于创建游标的结果集。\n比如：\nDECLARE cur_emp CURSOR FOR SELECT employee_id,salary FROM employees; DECLARE cursor_fruit CURSOR FOR SELECT f_name, f_price FROM fruits ; 第二步，打开游标\n打开游标的语法如下：\nOPEN cursor_name 当我们定义好游标之后，如果想要使用游标，必须先打开游标。打开游标的时候 SELECT 语句的查询结果集就会送到游标工作区，为后面游标的逐条读取结果集中的记录做准备。\nOPEN　cur_emp ; 第三步，使用游标（从游标中取得数据）\n语法如下：\nFETCH cursor_name INTO var_name [, var_name] ... 这句的作用是使用 cursor_name 这个游标来读取当前行，并且将数据保存到 var_name 这个变量中，游标指针指到下一行。如果游标读取的数据行有多个列名，则在 INTO 关键字后面赋值给多个变量名即可。\n注意：var_name必须在声明游标之前就定义好。\nFETCH　cur_emp INTO emp_id, emp_sal ; 注意：游标的查询结果集中的字段数，必须跟 INTO 后面的变量数一致，否则，在存储过程执行的时候，MySQL 会提示错误。\n第四步，关闭游标\nCLOSE cursor_name 有 OPEN 就会有 CLOSE，也就是打开和关闭游标。当我们使用完游标后需要关闭掉该游标。因为游标会占用系统资源，如果不及时关闭，游标会一直保持到存储过程结束，影响系统运行的效率。而关闭游标的操作，会释放游标占用的系统资源。\n关闭游标之后，我们就不能再检索查询结果中的数据行，如果需要检索只能再次打开游标。\nCLOSE　cur_emp; 4.3 举例 创建存储过程“get_count_by_limit_total_salary()”，声明IN参数 limit_total_salary，DOUBLE类型；声明OUT参数total_count，INT类型。函数的功能可以实现累加薪资最高的几个员工的薪资值，直到薪资总和达到limit_total_salary参数的值，返回累加的人数给total_count。\nDELIMITER //  CREATE PROCEDURE get_count_by_limit_total_salary(IN limit_total_salary DOUBLE,OUT total_count INT)  BEGIN \tDECLARE sum_salary DOUBLE DEFAULT 0; #记录累加的总工资 \tDECLARE cursor_salary DOUBLE DEFAULT 0; #记录某一个工资值 \tDECLARE emp_count INT DEFAULT 0; #记录循环个数 \t#定义游标 \tDECLARE emp_cursor CURSOR FOR SELECT salary FROM employees ORDER BY salary DESC; \t#打开游标 \tOPEN emp_cursor; \t\tREPEAT \t#使用游标（从游标中获取数据） \tFETCH emp_cursor INTO cursor_salary; \t\tSET sum_salary = sum_salary + cursor_salary; \tSET emp_count = emp_count + 1; \t\tUNTIL sum_salary = limit_total_salary \tEND REPEAT; \t\tSET total_count = emp_count; \t#关闭游标 \tCLOSE emp_cursor; \tEND //  DELIMITER ; 4.5 小结 游标是 MySQL 的一个重要的功能，为逐条读取结果集中的数据，提供了完美的解决方案。跟在应用层面实现相同的功能相比，游标可以在存储程序中使用，效率高，程序也更加简洁。\n但同时也会带来一些性能问题，比如在使用游标的过程中，会对数据行进行加锁，这样在业务并发量大的时候，不仅会影响业务之间的效率，还会消耗系统资源，造成内存不足，这是因为游标是在内存中进行的处理。\n建议：养成用完之后就关闭的习惯，这样才能提高系统的整体效率。\n补充：MySQL 8.0的新特性—全局变量的持久化 在MySQL数据库中，全局变量可以通过SET GLOBAL语句来设置。例如，设置服务器语句超时的限制，可以通过设置系统变量max_execution_time来实现：\nSET GLOBAL MAX_EXECUTION_TIME=2000; 使用SET GLOBAL语句设置的变量值只会临时生效。数据库重启后，服务器又会从MySQL配置文件中读取变量的默认值。 MySQL 8.0版本新增了SET PERSIST命令。例如，设置服务器的最大连接数为1000：\nSET PERSIST global max_connections = 1000; MySQL会将该命令的配置保存到数据目录下的mysqld-auto.cnf文件中，下次启动时会读取该文件，用其中的配置来覆盖默认的配置文件。\n举例：\n查看全局变量max_connections的值，结果如下：\nmysql show variables like '%max_connections%'; +------------------------+-------+ | Variable_name | Value | +------------------------+-------+ | max_connections | 151 | | mysqlx_max_connections | 100 | +------------------------+-------+ 2 rows in set, 1 warning (0.00 sec) 设置全局变量max_connections的值：\nmysql set persist max_connections=1000; Query OK, 0 rows affected (0.00 sec) 重启MySQL服务器，再次查询max_connections的值：\nmysql show variables like '%max_connections%'; +------------------------+-------+ | Variable_name | Value | +------------------------+-------+ | max_connections | 1000 | | mysqlx_max_connections | 100 | +------------------------+-------+ 2 rows in set, 1 warning (0.00 sec) ","wordCount":"2260","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jiayi26.github.io/posts/%E7%AC%AC16%E7%AB%A0_%E5%8F%98%E9%87%8F%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%B8%B8%E6%A0%87/"},"publisher":{"@type":"Organization","name":"JIAYI's Blog","logo":{"@type":"ImageObject","url":"https://xx.mzqcgc.cn/FrbOmxJvq96XDbDPXbiBWM0LU9e3"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jiayi26.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jiayi26.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://jiayi26.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jiayi26.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://jiayi26.github.io/posts/>Posts</a></div><h1 class=post-title>变量、流程控制与游标</h1><div class=post-meta>11 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Pass-JIAYI%27s.github.io/post/posts/%e7%ac%ac16%e7%ab%a0_%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h1 id=第16章_变量流程控制与游标>第16章_变量、流程控制与游标<a hidden class=anchor aria-hidden=true href=#第16章_变量流程控制与游标>#</a></h1><h2 id=1-变量>1. 变量<a hidden class=anchor aria-hidden=true href=#1-变量>#</a></h2><p>在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。</p><p>在 MySQL 数据库中，变量分为<code>系统变量</code>以及<code>用户自定义变量</code>。</p><h3 id=11-系统变量>1.1 系统变量<a hidden class=anchor aria-hidden=true href=#11-系统变量>#</a></h3><h4 id=111-系统变量分类>1.1.1 系统变量分类<a hidden class=anchor aria-hidden=true href=#111-系统变量分类>#</a></h4><p>变量由系统定义，不是用户定义，属于<code>服务器</code>层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是<code>编译MySQL时参数</code>的默认值，要么是<code>配置文件</code>（例如my.ini等）中的参数值。大家可以通过网址 <code>https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html</code> 查看MySQL文档的系统变量。</p><p>系统变量分为全局系统变量（需要添加<code>global</code> 关键字）以及会话系统变量（需要添加 <code>session</code> 关键字），有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。**如果不写，默认会话级别。**静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。</p><p>每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：</p><p><img loading=lazy src=../_resources/image-20211108114846634.png alt=image-20211108114846634></p><ul><li>全局系统变量针对于所有会话（连接）有效，但<code>不能跨重启</code></li><li>会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。</li><li>会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。</li></ul><p>在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。</p><h4 id=112-查看系统变量>1.1.2 查看系统变量<a hidden class=anchor aria-hidden=true href=#112-查看系统变量>#</a></h4><ul><li><strong>查看所有或部分系统变量</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#查看所有全局变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SHOW</span> GLOBAL VARIABLES;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看所有会话变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SHOW</span> SESSION VARIABLES;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>或</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> VARIABLES;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#查看满足条件的部分系统变量。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SHOW</span> GLOBAL VARIABLES <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%标识符%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看满足条件的部分会话变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SHOW</span> SESSION VARIABLES <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%标识符%&#39;</span>;
</span></span></code></pre></div><p>举例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> GLOBAL VARIABLES <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;admin_%&#39;</span>;
</span></span></code></pre></div><ul><li><strong>查看指定系统变量</strong></li></ul><p>作为 MySQL 编码规范，MySQL 中的系统变量以<code>两个“@”</code>开头，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#查看指定的系统变量的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span>global.<span style=color:#960050;background-color:#1e0010>变量名</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看指定的会话变量的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span>session.<span style=color:#960050;background-color:#1e0010>变量名</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#或者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span><span style=color:#960050;background-color:#1e0010>变量名</span>;
</span></span></code></pre></div><ul><li><strong>修改系统变量的值</strong></li></ul><p>有些时候，数据库管理员需要修改系统变量的默认值，以便修改当前会话或者MySQL服务实例的属性、特征。具体方法：</p><p>方式1：修改MySQL<code>配置文件</code>，继而修改MySQL系统变量的值（该方法需要重启MySQL服务）</p><p>方式2：在MySQL服务运行期间，使用“set”命令重新设置系统变量的值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#为某个系统变量赋值
</span></span></span><span style=display:flex><span><span style=color:#75715e>#方式1：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@@</span>global.<span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>变量值</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#方式2：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> GLOBAL <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>变量值</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#为某个会话变量赋值
</span></span></span><span style=display:flex><span><span style=color:#75715e>#方式1：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@@</span>session.<span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>变量值</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#方式2：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> SESSION <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>变量值</span>;
</span></span></code></pre></div><p>举例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span>global.autocommit;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> GLOBAL autocommit<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span>session.tx_isolation;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@@</span>session.tx_isolation<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;read-uncommitted&#39;</span>;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SET</span> GLOBAL max_connections <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span>global.max_connections;
</span></span></code></pre></div><h3 id=12-用户变量>1.2 用户变量<a hidden class=anchor aria-hidden=true href=#12-用户变量>#</a></h3><h4 id=121-用户变量分类>1.2.1 用户变量分类<a hidden class=anchor aria-hidden=true href=#121-用户变量分类>#</a></h4><p>用户变量是用户自己定义的，作为 MySQL 编码规范，MySQL 中的用户变量以<code>一个“@”</code>开头。根据作用范围不同，又分为<code>会话用户变量</code>和<code>局部变量</code>。</p><ul><li><p>会话用户变量：作用域和会话变量一样，只对<code>当前连接</code>会话有效。</p></li><li><p>局部变量：只在 BEGIN 和 END 语句块中有效。局部变量只能在<code>存储过程和函数</code>中使用。</p></li></ul><h4 id=122-会话用户变量>1.2.2 会话用户变量<a hidden class=anchor aria-hidden=true href=#122-会话用户变量>#</a></h4><ul><li>变量的定义</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#方式1：“=”或“:=”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span><span style=color:#960050;background-color:#1e0010>用户变量</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>值</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span><span style=color:#960050;background-color:#1e0010>用户变量</span> :<span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>值</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#方式2：“:=” 或 INTO关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span><span style=color:#960050;background-color:#1e0010>用户变量</span> :<span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>表达式</span> [<span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>等子句</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>表达式</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>@</span><span style=color:#960050;background-color:#1e0010>用户变量</span>  [<span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>等子句</span>];
</span></span></code></pre></div><ul><li>查看用户变量的值 （查看、比较、运算等）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span><span style=color:#960050;background-color:#1e0010>用户变量</span>
</span></span></code></pre></div><ul><li>举例</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>a <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>a;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>num :<span style=color:#f92672>=</span> <span style=color:#a6e22e>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>num;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>@</span>avgsalary <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>avgsalary;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>big;  <span style=color:#75715e>#查看某个未声明的变量时，将得到NULL值
</span></span></span></code></pre></div><h4 id=123-局部变量>1.2.3 局部变量<a hidden class=anchor aria-hidden=true href=#123-局部变量>#</a></h4><p>定义：可以使用<code>DECLARE</code>语句定义一个局部变量</p><p>作用域：仅仅在定义它的 BEGIN &mldr; END 中有效</p><p>位置：只能放在 BEGIN &mldr; END 中，而且只能放在第一句</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#75715e>#声明局部变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#ae81ff>1</span> <span style=color:#960050;background-color:#1e0010>变量数据类型</span> [<span style=color:#66d9ef>DEFAULT</span> <span style=color:#960050;background-color:#1e0010>变量默认值</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#ae81ff>2</span>,<span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#ae81ff>3</span>,... <span style=color:#960050;background-color:#1e0010>变量数据类型</span> [<span style=color:#66d9ef>DEFAULT</span> <span style=color:#960050;background-color:#1e0010>变量默认值</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#为局部变量赋值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>SET</span> <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>值</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>值</span> <span style=color:#66d9ef>INTO</span> <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#ae81ff>2</span> [<span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>子句</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#查看局部变量的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>变量</span><span style=color:#ae81ff>1</span>,<span style=color:#960050;background-color:#1e0010>变量</span><span style=color:#ae81ff>2</span>,<span style=color:#960050;background-color:#1e0010>变量</span><span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>END
</span></span></code></pre></div><p><strong>1.定义变量</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> <span style=color:#960050;background-color:#1e0010>变量名</span> <span style=color:#960050;background-color:#1e0010>类型</span> [<span style=color:#66d9ef>default</span> <span style=color:#960050;background-color:#1e0010>值</span>];  <span style=color:#75715e># 如果没有DEFAULT子句，初始值为NULL
</span></span></span></code></pre></div><p>举例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span>　myparam　<span style=color:#66d9ef>INT</span>　<span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><p><strong>2.变量赋值</strong></p><p>方式1：一般用于赋简单的值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#960050;background-color:#1e0010>变量名</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>值</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#960050;background-color:#1e0010>变量名</span>:<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>值</span>;
</span></span></code></pre></div><p>方式2：一般用于赋表中的字段值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>字段名或表达式</span> <span style=color:#66d9ef>INTO</span> <span style=color:#960050;background-color:#1e0010>变量名</span> <span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>表</span>;
</span></span></code></pre></div><p><strong>3.使用变量</strong>（查看、比较、运算等）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>局部变量名</span>;
</span></span></code></pre></div><p>举例1：声明局部变量，并分别赋值为employees表中employee_id为102的last_name和salary</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>set_value</span>()
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> emp_name <span style=color:#66d9ef>VARCHAR</span>(<span style=color:#ae81ff>25</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> sal <span style=color:#66d9ef>DOUBLE</span>(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> last_name,salary <span style=color:#66d9ef>INTO</span> emp_name,sal
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>FROM</span> employees 
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>102</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> emp_name,sal;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p>举例2：声明两个变量，求和并打印 （分别使用会话用户变量、局部变量的方式实现）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#方式1：使用用户变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>m<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>n<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>sum<span style=color:#f92672>=@</span>m<span style=color:#f92672>+@</span>n;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>sum;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#方式2：使用局部变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>add_value</span>()
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#75715e>#局部变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> m <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> n <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> SUM <span style=color:#66d9ef>INT</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> SUM <span style=color:#f92672>=</span> m<span style=color:#f92672>+</span>n;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> SUM;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p>举例3：创建存储过程“different_salary”查询某员工和他领导的薪资差距，并用IN参数emp_id接收员工id，用OUT参数dif_salary输出薪资差距结果。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#声明
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>different_salary</span>(<span style=color:#66d9ef>IN</span> emp_id <span style=color:#66d9ef>INT</span>,<span style=color:#66d9ef>OUT</span> dif_salary <span style=color:#66d9ef>DOUBLE</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#75715e>#声明局部变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> emp_sal,mgr_sal <span style=color:#66d9ef>DOUBLE</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> mgr_id <span style=color:#66d9ef>INT</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> emp_sal <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> manager_id <span style=color:#66d9ef>INTO</span> mgr_id <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> mgr_sal <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> mgr_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> dif_salary <span style=color:#f92672>=</span> mgr_sal <span style=color:#f92672>-</span> emp_sal;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>emp_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>102</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CALL</span> <span style=color:#a6e22e>different_salary</span>(<span style=color:#f92672>@</span>emp_id,<span style=color:#f92672>@</span>diff_sal);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>diff_sal;
</span></span></code></pre></div><h4 id=124-对比会话用户变量与局部变量>1.2.4 对比会话用户变量与局部变量<a hidden class=anchor aria-hidden=true href=#124-对比会话用户变量与局部变量>#</a></h4><pre tabindex=0><code>			  作用域					定义位置				  语法
会话用户变量	  当前会话				   会话的任何地方				加@符号，不用指定类型
局部变量	   定义它的BEGIN END中 		BEGIN END的第一句话		  一般不用加@,需要指定类型
</code></pre><h2 id=2-定义条件与处理程序>2. 定义条件与处理程序<a hidden class=anchor aria-hidden=true href=#2-定义条件与处理程序>#</a></h2><p><code>定义条件</code>是事先定义程序执行过程中可能遇到的问题，<code>处理程序</code>定义了在遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。这样可以增强存储程序处理问题的能力，避免程序异常停止运行。</p><p>说明：定义条件和处理程序在存储过程、存储函数中都是支持的。</p><h3 id=21-案例分析>2.1 案例分析<a hidden class=anchor aria-hidden=true href=#21-案例分析>#</a></h3><p>**案例分析：**创建一个名称为“UpdateDataNoCondition”的存储过程。代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>UpdateDataNoCondition</span>()
</span></span><span style=display:flex><span>	BEGIN
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> email <span style=color:#f92672>=</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>WHERE</span> last_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Abel&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;aabbel&#39;</span> <span style=color:#66d9ef>WHERE</span> last_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Abel&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>	END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p>调用存储过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>CALL</span> <span style=color:#a6e22e>UpdateDataNoCondition</span>();
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1048</span> (<span style=color:#ae81ff>23000</span>): <span style=color:#66d9ef>Column</span> <span style=color:#e6db74>&#39;email&#39;</span> cannot be <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>x;
</span></span><span style=display:flex><span><span style=color:#f92672>+------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#f92672>@</span>x   <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>1</span>  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><p>可以看到，此时@x变量的值为1。结合创建存储过程的SQL语句代码可以得出：在存储过程中未定义条件和处理程序，且当存储过程中执行的SQL语句报错时，MySQL数据库会抛出错误，并退出当前SQL逻辑，不再向下继续执行。</p><h3 id=22-定义条件>2.2 定义条件<a hidden class=anchor aria-hidden=true href=#22-定义条件>#</a></h3><p>定义条件就是给MySQL中的错误码命名，这有助于存储的程序代码更清晰。它将一个<code>错误名字</code>和<code>指定的错误条件</code>关联起来。这个名字可以随后被用在定义处理程序的<code>DECLARE HANDLER</code>语句中。</p><p>定义条件使用DECLARE语句，语法格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> <span style=color:#960050;background-color:#1e0010>错误名称</span> <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#960050;background-color:#1e0010>错误码（或错误条件）</span>
</span></span></code></pre></div><p>错误码的说明：</p><ul><li><code>MySQL_error_code</code>和<code>sqlstate_value</code>都可以表示MySQL的错误。<ul><li>MySQL_error_code是数值类型错误代码。</li><li>sqlstate_value是长度为5的字符串类型错误代码。</li></ul></li><li>例如，在ERROR 1418 (HY000)中，1418是MySQL_error_code，&lsquo;HY000&rsquo;是sqlstate_value。</li><li>例如，在ERROR 1142（42000）中，1142是MySQL_error_code，&lsquo;42000&rsquo;是sqlstate_value。</li></ul><p>**举例1：**定义“Field_Not_Be_NULL”错误名与MySQL中违反非空约束的错误类型是“ERROR 1048 (23000)”对应。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#使用MySQL_error_code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> Field_Not_Be_NULL <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#ae81ff>1048</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#使用sqlstate_value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> Field_Not_Be_NULL <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SQLSTATE</span> <span style=color:#e6db74>&#39;23000&#39;</span>;
</span></span></code></pre></div><p>**举例2：**定义"ERROR 1148(42000)&ldquo;错误，名称为command_not_allowed。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#使用MySQL_error_code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> command_not_allowed <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#ae81ff>1148</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#使用sqlstate_value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> command_not_allowed <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SQLSTATE</span> <span style=color:#e6db74>&#39;42000&#39;</span>;
</span></span></code></pre></div><h3 id=23-定义处理程序>2.3 定义处理程序<a hidden class=anchor aria-hidden=true href=#23-定义处理程序>#</a></h3><p>可以为SQL执行过程中发生的某种类型的错误定义特殊的处理程序。定义处理程序时，使用DECLARE语句的语法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> <span style=color:#960050;background-color:#1e0010>处理方式</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#960050;background-color:#1e0010>错误类型</span> <span style=color:#960050;background-color:#1e0010>处理语句</span>
</span></span></code></pre></div><ul><li><strong>处理方式</strong>：处理方式有3个取值：CONTINUE、EXIT、UNDO。<ul><li><code>CONTINUE</code>：表示遇到错误不处理，继续执行。</li><li><code>EXIT</code>：表示遇到错误马上退出。</li><li><code>UNDO</code>：表示遇到错误后撤回之前的操作。MySQL中暂时不支持这样的操作。</li></ul></li><li><strong>错误类型</strong>（即条件）可以有如下取值：<ul><li><code>SQLSTATE '字符串错误码'</code>：表示长度为5的sqlstate_value类型的错误代码；</li><li><code>MySQL_error_code</code>：匹配数值类型错误代码；</li><li><code>错误名称</code>：表示DECLARE &mldr; CONDITION定义的错误条件名称。</li><li><code>SQLWARNING</code>：匹配所有以01开头的SQLSTATE错误代码；</li><li><code>NOT FOUND</code>：匹配所有以02开头的SQLSTATE错误代码；</li><li><code>SQLEXCEPTION</code>：匹配所有没有被SQLWARNING或NOT FOUND捕获的SQLSTATE错误代码；</li></ul></li><li><strong>处理语句</strong>：如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像“<code>SET 变量 = 值</code>”这样的简单语句，也可以是使用<code>BEGIN ... END</code>编写的复合语句。</li></ul><p>定义处理程序的几种方式，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#方法1：捕获sqlstate_value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>CONTINUE</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SQLSTATE</span> <span style=color:#e6db74>&#39;42S02&#39;</span> <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;NO_SUCH_TABLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#方法2：捕获mysql_error_value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>CONTINUE</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#ae81ff>1146</span> <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;NO_SUCH_TABLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#方法3：先定义条件，再调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> no_such_table <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#ae81ff>1146</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>CONTINUE</span> HANDLER <span style=color:#66d9ef>FOR</span> NO_SUCH_TABLE <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;NO_SUCH_TABLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#方法4：使用SQLWARNING
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>EXIT</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SQLWARNING</span> <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ERROR&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#方法5：使用NOT FOUND
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>EXIT</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>NOT</span> FOUND <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;NO_SUCH_TABLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#方法6：使用SQLEXCEPTION
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>EXIT</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SQLEXCEPTION</span> <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ERROR&#39;</span>;
</span></span></code></pre></div><h3 id=24-案例解决>2.4 案例解决<a hidden class=anchor aria-hidden=true href=#24-案例解决>#</a></h3><p>在存储过程中，定义处理程序，捕获sqlstate_value值，当遇到MySQL_error_code值为1048时，执行CONTINUE操作，并且将@proc_value的值设置为-1。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>UpdateDataNoCondition</span>()
</span></span><span style=display:flex><span>	BEGIN
</span></span><span style=display:flex><span>		<span style=color:#75715e>#定义处理程序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>CONTINUE</span> HANDLER <span style=color:#66d9ef>FOR</span> <span style=color:#ae81ff>1048</span> <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>proc_value <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> email <span style=color:#f92672>=</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>WHERE</span> last_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Abel&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;aabbel&#39;</span> <span style=color:#66d9ef>WHERE</span> last_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Abel&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>	END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p>调用过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>CALL</span> <span style=color:#a6e22e>UpdateDataWithCondition</span>();
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> rows <span style=color:#a6e22e>affected</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>01</span> sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>x,<span style=color:#f92672>@</span>proc_value;
</span></span><span style=display:flex><span><span style=color:#f92672>+------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#f92672>@</span>x   <span style=color:#f92672>|</span> <span style=color:#f92672>@</span>proc_value <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>3</span> <span style=color:#f92672>|</span>       	 <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><p><strong>举例：</strong></p><p>创建一个名称为“InsertDataWithCondition”的存储过程，代码如下。</p><p>在存储过程中，定义处理程序，捕获sqlstate_value值，当遇到sqlstate_value值为23000时，执行EXIT操作，并且将@proc_value的值设置为-1。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#准备工作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> departments
</span></span><span style=display:flex><span><span style=color:#66d9ef>AS</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> atguigudb.<span style=color:#f92672>`</span>departments<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> departments
</span></span><span style=display:flex><span><span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>CONSTRAINT</span> uk_dept_name <span style=color:#66d9ef>UNIQUE</span>(department_id);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>InsertDataWithCondition</span>()
</span></span><span style=display:flex><span>	BEGIN
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>DECLARE</span> duplicate_entry <span style=color:#66d9ef>CONDITION</span> <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SQLSTATE</span> <span style=color:#e6db74>&#39;23000&#39;</span> ;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>DECLARE</span> <span style=color:#66d9ef>EXIT</span> HANDLER <span style=color:#66d9ef>FOR</span> duplicate_entry <span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>proc_value <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#a6e22e>departments</span>(department_name) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;测试&#39;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#a6e22e>departments</span>(department_name) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;测试&#39;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> <span style=color:#f92672>@</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>	END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p>调用存储过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>CALL</span> <span style=color:#a6e22e>InsertDataWithCondition</span>();
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> rows <span style=color:#a6e22e>affected</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>01</span> sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>x,<span style=color:#f92672>@</span>proc_value;
</span></span><span style=display:flex><span><span style=color:#f92672>+------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#f92672>@</span>x   <span style=color:#f92672>|</span> <span style=color:#f92672>@</span>proc_value <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span>       	 <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><h2 id=3-流程控制>3. 流程控制<a hidden class=anchor aria-hidden=true href=#3-流程控制>#</a></h2><p>解决复杂问题不可能通过一个 SQL 语句完成，我们需要执行多个 SQL 操作。流程控制语句的作用就是控制存储过程中 SQL 语句的执行顺序，是我们完成复杂操作必不可少的一部分。只要是执行的程序，流程就分为三大类：</p><ul><li><code>顺序结构</code>：程序从上往下依次执行</li><li><code>分支结构</code>：程序按条件进行选择执行，从两条或多条路径中选择一条执行</li><li><code>循环结构</code>：程序满足一定条件下，重复执行一组语句</li></ul><p>针对于MySQL 的流程控制语句主要有 3 类。注意：只能用于存储程序。</p><ul><li><code>条件判断语句</code>：IF 语句和 CASE 语句</li><li><code>循环语句</code>：LOOP、WHILE 和 REPEAT 语句</li><li><code>跳转语句</code>：ITERATE 和 LEAVE 语句</li></ul><h3 id=31-分支结构之-if>3.1 分支结构之 IF<a hidden class=anchor aria-hidden=true href=#31-分支结构之-if>#</a></h3><ul><li>IF 语句的语法结构是：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>IF</span> <span style=color:#960050;background-color:#1e0010>表达式</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#960050;background-color:#1e0010>操作</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>[<span style=color:#66d9ef>ELSEIF</span> <span style=color:#960050;background-color:#1e0010>表达式</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>THEN</span> <span style=color:#960050;background-color:#1e0010>操作</span><span style=color:#ae81ff>2</span>]<span style=color:#960050;background-color:#1e0010>……</span>
</span></span><span style=display:flex><span>[<span style=color:#66d9ef>ELSE</span> <span style=color:#960050;background-color:#1e0010>操作</span>N]
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>IF</span>
</span></span></code></pre></div><p>根据表达式的结果为TRUE或FALSE执行相应的语句。这里“[]”中的内容是可选的。</p><ul><li><p>特点：① 不同的表达式对应不同的操作 ② 使用在begin end中</p></li><li><p><strong>举例1：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>IF</span> val <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> 
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is null&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is not null&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>IF</span>;
</span></span></code></pre></div></li><li><p>**举例2：**声明存储过程“update_salary_by_eid1”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于8000元并且入职时间超过5年，就涨薪500元；否则就不变。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_by_eid1</span>(<span style=color:#66d9ef>IN</span> emp_id <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> emp_salary <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> hire_year <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> emp_salary <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>DATEDIFF</span>(<span style=color:#a6e22e>CURDATE</span>(),hire_date)<span style=color:#f92672>/</span><span style=color:#ae81ff>365</span> <span style=color:#66d9ef>INTO</span> hire_year
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>IF</span> emp_salary <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>8000</span> <span style=color:#66d9ef>AND</span> hire_year <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>+</span> <span style=color:#ae81ff>500</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div></li><li><p>**举例3：**声明存储过程“update_salary_by_eid2”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元并且入职时间超过5年，就涨薪500元；否则就涨薪100元。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_by_eid2</span>(<span style=color:#66d9ef>IN</span> emp_id <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> emp_salary <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> hire_year <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> emp_salary <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>DATEDIFF</span>(<span style=color:#a6e22e>CURDATE</span>(),hire_date)<span style=color:#f92672>/</span><span style=color:#ae81ff>365</span> <span style=color:#66d9ef>INTO</span> hire_year
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>IF</span> emp_salary <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>8000</span> <span style=color:#66d9ef>AND</span> hire_year <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>+</span> <span style=color:#ae81ff>500</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>ELSE</span> 
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div></li><li><p>**举例4：**声明存储过程“update_salary_by_eid3”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资如果大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_by_eid3</span>(<span style=color:#66d9ef>IN</span> emp_id <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> emp_salary <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> bonus <span style=color:#66d9ef>DECIMAL</span>(<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> emp_salary <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> commission_pct <span style=color:#66d9ef>INTO</span> bonus <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>IF</span> emp_salary <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>9000</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> <span style=color:#ae81ff>9000</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>ELSEIF</span> emp_salary <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10000</span> <span style=color:#66d9ef>AND</span> bonus <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> commission_pct <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>01</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>ELSE</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div></li></ul><h3 id=32-分支结构之-case>3.2 分支结构之 CASE<a hidden class=anchor aria-hidden=true href=#32-分支结构之-case>#</a></h3><p>CASE 语句的语法结构1：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#情况一：类似于switch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CASE</span> <span style=color:#960050;background-color:#1e0010>表达式</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHEN</span> <span style=color:#960050;background-color:#1e0010>值</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#960050;background-color:#1e0010>结果</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>或语句</span><span style=color:#ae81ff>1</span>(<span style=color:#960050;background-color:#1e0010>如果是语句，需要加分号</span>) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHEN</span> <span style=color:#960050;background-color:#1e0010>值</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>THEN</span> <span style=color:#960050;background-color:#1e0010>结果</span><span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>或语句</span><span style=color:#ae81ff>2</span>(<span style=color:#960050;background-color:#1e0010>如果是语句，需要加分号</span>)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>ELSE</span> <span style=color:#960050;background-color:#1e0010>结果</span><span style=color:#a6e22e>n或语句n</span>(<span style=color:#960050;background-color:#1e0010>如果是语句，需要加分号</span>)
</span></span><span style=display:flex><span>END [<span style=color:#66d9ef>case</span>]<span style=color:#960050;background-color:#1e0010>（如果是放在</span>begin end中需要加上case<span style=color:#960050;background-color:#1e0010>，如果放在</span>select后面不需要<span style=color:#960050;background-color:#1e0010>）</span>
</span></span></code></pre></div><p>CASE 语句的语法结构2：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e>#情况二：类似于多重if
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CASE</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHEN</span> <span style=color:#960050;background-color:#1e0010>条件</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#960050;background-color:#1e0010>结果</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>或语句</span><span style=color:#ae81ff>1</span>(<span style=color:#960050;background-color:#1e0010>如果是语句，需要加分号</span>) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHEN</span> <span style=color:#960050;background-color:#1e0010>条件</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>THEN</span> <span style=color:#960050;background-color:#1e0010>结果</span><span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>或语句</span><span style=color:#ae81ff>2</span>(<span style=color:#960050;background-color:#1e0010>如果是语句，需要加分号</span>)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>ELSE</span> <span style=color:#960050;background-color:#1e0010>结果</span><span style=color:#a6e22e>n或语句n</span>(<span style=color:#960050;background-color:#1e0010>如果是语句，需要加分号</span>)
</span></span><span style=display:flex><span>END [<span style=color:#66d9ef>case</span>]<span style=color:#960050;background-color:#1e0010>（如果是放在</span>begin end中需要加上case<span style=color:#960050;background-color:#1e0010>，如果放在</span>select后面不需要<span style=color:#960050;background-color:#1e0010>）</span>
</span></span></code></pre></div><ul><li><strong>举例1：</strong></li></ul><p>使用CASE流程控制语句的第1种格式，判断val值等于1、等于2，或者两者都不等。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>CASE</span> val
</span></span><span style=display:flex><span>　　　<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is 1&#39;</span>;
</span></span><span style=display:flex><span>　　　<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is 2&#39;</span>;
</span></span><span style=display:flex><span>　　　<span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is not 1 or 2&#39;</span>;
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>CASE</span>;
</span></span></code></pre></div><ul><li><strong>举例2：</strong></li></ul><p>使用CASE流程控制语句的第2种格式，判断val是否为空、小于0、大于0或者等于0。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>CASE</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHEN</span> val <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is null&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHEN</span> val <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is less than 0&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHEN</span> val <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is greater than 0&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;val is 0&#39;</span>;
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>CASE</span>;
</span></span></code></pre></div><ul><li>**举例3：**声明存储过程“update_salary_by_eid4”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_by_eid4</span>(<span style=color:#66d9ef>IN</span> emp_id <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> emp_sal <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> bonus <span style=color:#66d9ef>DECIMAL</span>(<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> emp_sal <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> commission_pct <span style=color:#66d9ef>INTO</span> bonus <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>CASE</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHEN</span> emp_sal<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>9000</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span><span style=color:#ae81ff>9000</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHEN</span> emp_sal<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>10000</span> <span style=color:#66d9ef>AND</span> bonus <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> commission_pct<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>01</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>ELSE</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>100</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>CASE</span>;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><ul><li>举例4：声明存储过程update_salary_by_eid5，定义IN参数emp_id，输入员工编号。判断该员工的入职年限，如果是0年，薪资涨50；如果是1年，薪资涨100；如果是2年，薪资涨200；如果是3年，薪资涨300；如果是4年，薪资涨400；其他的涨薪500。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_by_eid5</span>(<span style=color:#66d9ef>IN</span> emp_id <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> emp_sal <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> hire_year <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>INTO</span> emp_sal <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>ROUND</span>(<span style=color:#a6e22e>DATEDIFF</span>(<span style=color:#a6e22e>CURDATE</span>(),hire_date)<span style=color:#f92672>/</span><span style=color:#ae81ff>365</span>) <span style=color:#66d9ef>INTO</span> hire_year <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>CASE</span> hire_year
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>50</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>100</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>200</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>3</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>300</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>WHEN</span> <span style=color:#ae81ff>4</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>400</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary<span style=color:#f92672>=</span>salary<span style=color:#f92672>+</span><span style=color:#ae81ff>500</span> <span style=color:#66d9ef>WHERE</span> employee_id <span style=color:#f92672>=</span> emp_id;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>CASE</span>;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><h3 id=33-循环结构之loop>3.3 循环结构之LOOP<a hidden class=anchor aria-hidden=true href=#33-循环结构之loop>#</a></h3><p>LOOP循环语句用来重复执行某些语句。LOOP内的语句一直重复执行直到循环被退出（使用LEAVE子句），跳出循环过程。</p><p>LOOP语句的基本格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>[loop_label:] <span style=color:#66d9ef>LOOP</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>循环执行的语句</span>
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>LOOP</span> [loop_label]
</span></span></code></pre></div><p>其中，loop_label表示LOOP语句的标注名称，该参数可以省略。</p><p><strong>举例1：</strong></p><p>使用LOOP语句进行循环操作，id值小于10时将重复执行循环过程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> id <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>add_loop:<span style=color:#66d9ef>LOOP</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> id <span style=color:#f92672>=</span> id <span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>IF</span> id <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>LEAVE</span> add_loop;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>LOOP</span> add_loop;
</span></span></code></pre></div><p>**举例2：**当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程“update_salary_loop()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.1倍。直到全公司的平均薪资达到12000结束。并统计循环次数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_loop</span>(<span style=color:#66d9ef>OUT</span> num <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> avg_salary <span style=color:#66d9ef>DOUBLE</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> loop_count <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_salary <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	label_loop:<span style=color:#66d9ef>LOOP</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>IF</span> avg_salary <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>12000</span> <span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>LEAVE</span> label_loop;
</span></span><span style=display:flex><span>		END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> loop_count <span style=color:#f92672>=</span> loop_count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_salary <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>LOOP</span> label_loop;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> num <span style=color:#f92672>=</span> loop_count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><h3 id=34-循环结构之while>3.4 循环结构之WHILE<a hidden class=anchor aria-hidden=true href=#34-循环结构之while>#</a></h3><p>WHILE语句创建一个带条件判断的循环过程。WHILE在执行语句执行时，先对指定的表达式进行判断，如果为真，就执行循环内的语句，否则退出循环。WHILE语句的基本格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>[while_label:] <span style=color:#66d9ef>WHILE</span> <span style=color:#960050;background-color:#1e0010>循环条件</span>  DO
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>循环体</span>
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>WHILE</span> [while_label];
</span></span></code></pre></div><p>while_label为WHILE语句的标注名称；如果循环条件结果为真，WHILE语句内的语句或语句群被执行，直至循环条件为假，退出循环。</p><p><strong>举例1：</strong></p><p>WHILE语句示例，i值小于10时，将重复执行循环过程，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>test_while</span>()
</span></span><span style=display:flex><span>BEGIN	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> i <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHILE</span> i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span> DO
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>WHILE</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> i;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span><span style=display:flex><span><span style=color:#75715e>#调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CALL</span> <span style=color:#a6e22e>test_while</span>();
</span></span></code></pre></div><p>**举例2：**市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“update_salary_while()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家降薪，薪资降为原来的90%。直到全公司的平均薪资达到5000结束。并统计循环次数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_while</span>(<span style=color:#66d9ef>OUT</span> num <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> avg_sal <span style=color:#66d9ef>DOUBLE</span> ;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> while_count <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_sal <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>WHILE</span> avg_sal <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5000</span> DO
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>9</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> while_count <span style=color:#f92672>=</span> while_count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_sal <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>WHILE</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> num <span style=color:#f92672>=</span> while_count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><h3 id=35-循环结构之repeat>3.5 循环结构之REPEAT<a hidden class=anchor aria-hidden=true href=#35-循环结构之repeat>#</a></h3><p>REPEAT语句创建一个带条件判断的循环过程。与WHILE循环不同的是，REPEAT 循环首先会执行一次循环，然后在 UNTIL 中进行表达式的判断，如果满足条件就退出，即 END REPEAT；如果条件不满足，则会就继续执行循环，直到满足退出条件为止。</p><p>REPEAT语句的基本格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>[repeat_label:] <span style=color:#66d9ef>REPEAT</span>
</span></span><span style=display:flex><span>　　　　<span style=color:#960050;background-color:#1e0010>循环体的语句</span>
</span></span><span style=display:flex><span>UNTIL <span style=color:#960050;background-color:#1e0010>结束循环的条件表达式</span>
</span></span><span style=display:flex><span>END <span style=color:#66d9ef>REPEAT</span> [repeat_label]
</span></span></code></pre></div><p>repeat_label为REPEAT语句的标注名称，该参数可以省略；REPEAT语句内的语句或语句群被重复，直至expr_condition为真。</p><p><strong>举例1：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>test_repeat</span>()
</span></span><span style=display:flex><span>BEGIN	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> i <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>REPEAT</span> 
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	UNTIL i <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>REPEAT</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> i;
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p>**举例2：**当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程“update_salary_repeat()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.15倍。直到全公司的平均薪资达到13000结束。并统计循环次数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>update_salary_repeat</span>(<span style=color:#66d9ef>OUT</span> num <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> avg_sal <span style=color:#66d9ef>DOUBLE</span> ;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> repeat_count <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_sal <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>REPEAT</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary <span style=color:#f92672>=</span> salary <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>15</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> repeat_count <span style=color:#f92672>=</span> repeat_count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_sal <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	UNTIL avg_sal <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>13000</span>
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>REPEAT</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> num <span style=color:#f92672>=</span> repeat_count;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p><strong>对比三种循环结构：</strong></p><p>1、这三种循环都可以省略名称，但如果循环中添加了循环控制语句（LEAVE或ITERATE）则必须添加名称。
2、
LOOP：一般用于实现简单的"死"循环
WHILE：先判断后执行
REPEAT：先执行后判断，无条件至少执行一次</p><h3 id=36-跳转语句之leave语句>3.6 跳转语句之LEAVE语句<a hidden class=anchor aria-hidden=true href=#36-跳转语句之leave语句>#</a></h3><p>LEAVE语句：可以用在循环语句内，或者以 BEGIN 和 END 包裹起来的程序体内，表示跳出循环或者跳出程序体的操作。如果你有面向过程的编程语言的使用经验，你可以把 LEAVE 理解为 break。</p><p>基本格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>LEAVE</span> <span style=color:#960050;background-color:#1e0010>标记名</span>
</span></span></code></pre></div><p>其中，label参数表示循环的标志。LEAVE和BEGIN &mldr; END或循环一起被使用。</p><p>**举例1：**创建存储过程 “leave_begin()”，声明INT类型的IN参数num。给BEGIN&mldr;END加标记名，并在BEGIN&mldr;END中使用IF语句判断num参数的值。</p><ul><li>如果num&lt;=0，则使用LEAVE语句退出BEGIN&mldr;END；</li><li>如果num=1，则查询“employees”表的平均薪资；</li><li>如果num=2，则查询“employees”表的最低薪资；</li><li>如果num>2，则查询“employees”表的最高薪资。</li></ul><p>IF语句结束后查询“employees”表的总人数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>leave_begin</span>(<span style=color:#66d9ef>IN</span> num <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	begin_label: BEGIN
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>IF</span> num<span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>LEAVE</span> begin_label;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>ELSEIF</span> num<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>ELSEIF</span> num<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> 
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>MIN</span>(salary) <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>ELSE</span> 
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>MAX</span>(salary) <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>		END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><p><strong>举例2：</strong></p><p>当市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“leave_while()”，声明OUT参数num，输出循环次数，存储过程中使用WHILE循环给大家降低薪资为原来薪资的90%，直到全公司的平均薪资小于等于10000，并统计循环次数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>leave_while</span>(<span style=color:#66d9ef>OUT</span> num <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BEGIN 
</span></span><span style=display:flex><span>	<span style=color:#75715e>#
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> avg_sal <span style=color:#66d9ef>DOUBLE</span>;<span style=color:#75715e>#记录平均工资
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> while_count <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>#记录循环次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_sal <span style=color:#66d9ef>FROM</span> employees; <span style=color:#75715e>#① 初始化条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	while_label:<span style=color:#66d9ef>WHILE</span> <span style=color:#66d9ef>TRUE</span> DO  <span style=color:#75715e>#② 循环条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		
</span></span><span style=display:flex><span>		<span style=color:#75715e>#③ 循环体
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>IF</span> avg_sal <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10000</span> <span style=color:#66d9ef>THEN</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>LEAVE</span> while_label;
</span></span><span style=display:flex><span>		END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>UPDATE</span> employees <span style=color:#66d9ef>SET</span> salary  <span style=color:#f92672>=</span> salary <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>9</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> while_count <span style=color:#f92672>=</span> while_count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#75715e>#④ 迭代条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>SELECT</span> <span style=color:#a6e22e>AVG</span>(salary) <span style=color:#66d9ef>INTO</span> avg_sal <span style=color:#66d9ef>FROM</span> employees;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>WHILE</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>#赋值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>SET</span> num <span style=color:#f92672>=</span> while_count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><h3 id=37-跳转语句之iterate语句>3.7 跳转语句之ITERATE语句<a hidden class=anchor aria-hidden=true href=#37-跳转语句之iterate语句>#</a></h3><p>ITERATE语句：只能用在循环语句（LOOP、REPEAT和WHILE语句）内，表示重新开始循环，将执行顺序转到语句段开头处。如果你有面向过程的编程语言的使用经验，你可以把 ITERATE 理解为 continue，意思为“再次循环”。</p><p>语句基本格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>ITERATE</span> label
</span></span></code></pre></div><p>label参数表示循环的标志。ITERATE语句必须跟在循环标志前面。</p><p><strong>举例：</strong> 定义局部变量num，初始值为0。循环结构中执行num + 1操作。</p><ul><li>如果num &lt; 10，则继续执行循环；</li><li>如果num > 15，则退出循环结构；</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>test_iterate</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> num <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	my_loop:<span style=color:#66d9ef>LOOP</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> num <span style=color:#f92672>=</span> num <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>IF</span> num <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span> 
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>ITERATE</span> my_loop;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>ELSEIF</span> num <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>15</span> 
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>THEN</span> <span style=color:#66d9ef>LEAVE</span> my_loop;
</span></span><span style=display:flex><span>		END <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;尚硅谷：让天下没有难学的技术&#39;</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>LOOP</span> my_loop;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><h2 id=4-游标>4. 游标<a hidden class=anchor aria-hidden=true href=#4-游标>#</a></h2><h3 id=41-什么是游标或光标>4.1 什么是游标（或光标）<a hidden class=anchor aria-hidden=true href=#41-什么是游标或光标>#</a></h3><p>虽然我们也可以通过筛选条件 WHERE 和 HAVING，或者是限定返回记录的关键字 LIMIT 返回一条记录，但是，却无法在结果集中像指针一样，向前定位一条记录、向后定位一条记录，或者是<code>随意定位到某一条记录</code>，并对记录的数据进行处理。</p><p>这个时候，就可以用到游标。游标，提供了一种灵活的操作方式，让我们能够对结果集中的每一条记录进行定位，并对指向的记录中的数据进行操作的数据结构。<strong>游标让 SQL 这种面向集合的语言有了面向过程开发的能力。</strong></p><p>在 SQL 中，游标是一种临时的数据库对象，可以指向存储在数据库表中的数据行指针。这里游标<code>充当了指针的作用</code>，我们可以通过操作游标来对数据行进行操作。</p><p>MySQL中游标可以在存储过程和函数中使用。</p><p>比如，我们查询了 employees 数据表中工资高于15000的员工都有哪些：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> employee_id,last_name,salary <span style=color:#66d9ef>FROM</span> employees
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> salary <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>15000</span>;
</span></span></code></pre></div><p><img loading=lazy src=../_resources/image-20211111182656990.png alt=image-20211111182656990></p><p>这里我们就可以通过游标来操作数据行，如图所示此时游标所在的行是“108”的记录，我们也可以在结果集上滚动游标，指向结果集中的任意一行。</p><h3 id=42-使用游标步骤>4.2 使用游标步骤<a hidden class=anchor aria-hidden=true href=#42-使用游标步骤>#</a></h3><p>游标必须在声明处理程序之前被声明，并且变量和条件还必须在声明游标或处理程序之前被声明。</p><p>如果我们想要使用游标，一般需要经历四个步骤。不同的 DBMS 中，使用游标的语法可能略有不同。</p><p><strong>第一步，声明游标</strong></p><p>在MySQL中，使用DECLARE关键字来声明游标，其语法的基本形式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> cursor_name <span style=color:#66d9ef>CURSOR</span> <span style=color:#66d9ef>FOR</span> select_statement; 
</span></span></code></pre></div><p>这个语法适用于 MySQL，SQL Server，DB2 和 MariaDB。如果是用 Oracle 或者 PostgreSQL，需要写成：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> cursor_name <span style=color:#66d9ef>CURSOR</span> <span style=color:#66d9ef>IS</span> select_statement;
</span></span></code></pre></div><p>要使用 SELECT 语句来获取数据结果集，而此时还没有开始遍历数据，这里 select_statement 代表的是 SELECT 语句，返回一个用于创建游标的结果集。</p><p>比如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> cur_emp <span style=color:#66d9ef>CURSOR</span> <span style=color:#66d9ef>FOR</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> employee_id,salary <span style=color:#66d9ef>FROM</span> employees;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span> cursor_fruit <span style=color:#66d9ef>CURSOR</span> <span style=color:#66d9ef>FOR</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> f_name, f_price <span style=color:#66d9ef>FROM</span> fruits ;
</span></span></code></pre></div><p><strong>第二步，打开游标</strong></p><p>打开游标的语法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>OPEN cursor_name
</span></span></code></pre></div><p>当我们定义好游标之后，如果想要使用游标，必须先打开游标。打开游标的时候 SELECT 语句的查询结果集就会送到游标工作区，为后面游标的<code>逐条读取</code>结果集中的记录做准备。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>OPEN　cur_emp ;
</span></span></code></pre></div><p><strong>第三步，使用游标（从游标中取得数据）</strong></p><p>语法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>FETCH</span> cursor_name <span style=color:#66d9ef>INTO</span> var_name [, var_name] ...
</span></span></code></pre></div><p>这句的作用是使用 cursor_name 这个游标来读取当前行，并且将数据保存到 var_name 这个变量中，游标指针指到下一行。如果游标读取的数据行有多个列名，则在 INTO 关键字后面赋值给多个变量名即可。</p><p>注意：var_name必须在声明游标之前就定义好。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>FETCH</span>　cur_emp <span style=color:#66d9ef>INTO</span> emp_id, emp_sal ;
</span></span></code></pre></div><p>注意：<strong>游标的查询结果集中的字段数，必须跟 INTO 后面的变量数一致</strong>，否则，在存储过程执行的时候，MySQL 会提示错误。</p><p><strong>第四步，关闭游标</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>CLOSE cursor_name
</span></span></code></pre></div><p>有 OPEN 就会有 CLOSE，也就是打开和关闭游标。当我们使用完游标后需要关闭掉该游标。因为游标会<code>占用系统资源</code>，如果不及时关闭，<strong>游标会一直保持到存储过程结束</strong>，影响系统运行的效率。而关闭游标的操作，会释放游标占用的系统资源。</p><p>关闭游标之后，我们就不能再检索查询结果中的数据行，如果需要检索只能再次打开游标。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>CLOSE　cur_emp;
</span></span></code></pre></div><h3 id=43-举例>4.3 举例<a hidden class=anchor aria-hidden=true href=#43-举例>#</a></h3><p>创建存储过程“get_count_by_limit_total_salary()”，声明IN参数 limit_total_salary，DOUBLE类型；声明OUT参数total_count，INT类型。函数的功能可以实现累加薪资最高的几个员工的薪资值，直到薪资总和达到limit_total_salary参数的值，返回累加的人数给total_count。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>DELIMITER <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> <span style=color:#a6e22e>get_count_by_limit_total_salary</span>(<span style=color:#66d9ef>IN</span> limit_total_salary <span style=color:#66d9ef>DOUBLE</span>,<span style=color:#66d9ef>OUT</span> total_count <span style=color:#66d9ef>INT</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>DECLARE</span> sum_salary <span style=color:#66d9ef>DOUBLE</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>#记录累加的总工资
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> cursor_salary <span style=color:#66d9ef>DOUBLE</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>#记录某一个工资值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> emp_count <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>#记录循环个数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#定义游标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>DECLARE</span> emp_cursor <span style=color:#66d9ef>CURSOR</span> <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>SELECT</span> salary <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> salary <span style=color:#66d9ef>DESC</span>;
</span></span><span style=display:flex><span>	<span style=color:#75715e>#打开游标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	OPEN emp_cursor;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>REPEAT</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#使用游标（从游标中获取数据）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>FETCH</span> emp_cursor <span style=color:#66d9ef>INTO</span> cursor_salary;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> sum_salary <span style=color:#f92672>=</span> sum_salary <span style=color:#f92672>+</span> cursor_salary;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>SET</span> emp_count <span style=color:#f92672>=</span> emp_count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		UNTIL sum_salary <span style=color:#f92672>&gt;=</span> limit_total_salary
</span></span><span style=display:flex><span>	END <span style=color:#66d9ef>REPEAT</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SET</span> total_count <span style=color:#f92672>=</span> emp_count;
</span></span><span style=display:flex><span>	<span style=color:#75715e>#关闭游标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	CLOSE emp_cursor;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>END <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELIMITER ;
</span></span></code></pre></div><h3 id=45-小结>4.5 小结<a hidden class=anchor aria-hidden=true href=#45-小结>#</a></h3><p>游标是 MySQL 的一个重要的功能，为<code>逐条读取</code>结果集中的数据，提供了完美的解决方案。跟在应用层面实现相同的功能相比，游标可以在存储程序中使用，效率高，程序也更加简洁。</p><p>但同时也会带来一些性能问题，比如在使用游标的过程中，会对数据行进行<code>加锁</code>，这样在业务并发量大的时候，不仅会影响业务之间的效率，还会<code>消耗系统资源</code>，造成内存不足，这是因为游标是在内存中进行的处理。</p><p>建议：养成用完之后就关闭的习惯，这样才能提高系统的整体效率。</p><h2 id=补充mysql-80的新特性全局变量的持久化>补充：MySQL 8.0的新特性—全局变量的持久化<a hidden class=anchor aria-hidden=true href=#补充mysql-80的新特性全局变量的持久化>#</a></h2><p>在MySQL数据库中，全局变量可以通过SET GLOBAL语句来设置。例如，设置服务器语句超时的限制，可以通过设置系统变量max_execution_time来实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SET</span> GLOBAL MAX_EXECUTION_TIME<span style=color:#f92672>=</span><span style=color:#ae81ff>2000</span>;
</span></span></code></pre></div><p>使用SET GLOBAL语句设置的变量值只会<code>临时生效</code>。<code>数据库重启</code>后，服务器又会从MySQL配置文件中读取变量的默认值。
MySQL 8.0版本新增了<code>SET PERSIST</code>命令。例如，设置服务器的最大连接数为1000：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>SET</span> PERSIST global max_connections <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>;
</span></span></code></pre></div><p>MySQL会将该命令的配置保存到数据目录下的<code>mysqld-auto.cnf</code>文件中，下次启动时会读取该文件，用其中的配置来覆盖默认的配置文件。</p><p>举例：</p><p>查看全局变量max_connections的值，结果如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>show</span> variables <span style=color:#66d9ef>like</span> <span style=color:#e6db74>&#39;%max_connections%&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+------------------------+-------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> Variable_name          <span style=color:#f92672>|</span> Value <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------------------------+-------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> max_connections        <span style=color:#f92672>|</span> <span style=color:#ae81ff>151</span>   <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> mysqlx_max_connections <span style=color:#f92672>|</span> <span style=color:#ae81ff>100</span>   <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------------------------+-------+</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> rows <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span>, <span style=color:#ae81ff>1</span> <span style=color:#a6e22e>warning</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><p>设置全局变量max_connections的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> persist max_connections<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> rows <span style=color:#a6e22e>affected</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><p><code>重启MySQL服务器</code>，再次查询max_connections的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>show</span> variables <span style=color:#66d9ef>like</span> <span style=color:#e6db74>&#39;%max_connections%&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+------------------------+-------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> Variable_name          <span style=color:#f92672>|</span> Value <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------------------------+-------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> max_connections        <span style=color:#f92672>|</span> <span style=color:#ae81ff>1000</span>  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> mysqlx_max_connections <span style=color:#f92672>|</span> <span style=color:#ae81ff>100</span>   <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------------------------+-------+</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> rows <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span>, <span style=color:#ae81ff>1</span> <span style=color:#a6e22e>warning</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://jiayi26.github.io/tags/mysql/>MySQL</a></li></ul><nav class=paginav><a class=prev href=https://jiayi26.github.io/posts/%E7%AC%AC07%E7%AB%A0_%E5%8D%95%E8%A1%8C%E5%87%BD%E6%95%B0/><span class=title>« Prev Page</span><br><span>单行函数</span></a>
<a class=next href=https://jiayi26.github.io/posts/%E7%AC%AC03%E7%AB%A0_%E5%9F%BA%E6%9C%AC%E7%9A%84select%E8%AF%AD%E5%8F%A5/><span class=title>Next Page »</span><br><span>基本的SELECT语句</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 变量、流程控制与游标 on twitter" href="https://twitter.com/intent/tweet/?text=%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87&url=https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f&hashtags=MySQL"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 变量、流程控制与游标 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f&title=%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87&summary=%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87&source=https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 变量、流程控制与游标 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f&title=%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 变量、流程控制与游标 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 变量、流程控制与游标 on whatsapp" href="https://api.whatsapp.com/send?text=%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87%20-%20https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 变量、流程控制与游标 on telegram" href="https://telegram.me/share/url?text=%e5%8f%98%e9%87%8f%e3%80%81%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%b8%b8%e6%a0%87&url=https%3a%2f%2fjiayi26.github.io%2fposts%2f%25E7%25AC%25AC16%25E7%25AB%25A0_%25E5%258F%2598%25E9%2587%258F%25E6%25B5%2581%25E7%25A8%258B%25E6%258E%25A7%25E5%2588%25B6%25E4%25B8%258E%25E6%25B8%25B8%25E6%25A0%2587%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://jiayi26.github.io/>JIAYI's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>